<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us">
<head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>CoffeeScript Model Classes like Playframework's Models</title>
    <meta name="author" content="k33g" />

    <!-- Homepage CSS -->
    <!--
    <link rel="stylesheet" href="http://twitter.github.io/bootstrap/assets/css/bootstrap.css">
    <link rel="stylesheet" href="/css/screen.css" type="text/css" media="screen, projection" />
	-->

    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1">
    <link href="/bootstrap3/css/bootstrap.css" rel="stylesheet" type="text/css">
    <script type="text/javascript" src="bootstrap3/js/bootstrap.min.js"></script>

    <style>
        .jumbotron {
            background-color: #b8eee9;
            border-radius: 0px;
            padding: 10px 30px;
        }
    </style>

    <!-- syntax highlighting CSS -->
    <link rel="stylesheet" href="/css/syntax.css" type="text/css" />
		<link rel="stylesheet" href="/css/default.min.css">


    <script type="text/javascript" src="https://apis.google.com/js/plusone.js"></script>

</head>

<body >

<div class="jumbotron">
    <a class="label label-warning" href="/">K33G_ORG's Blog</a>
    <a class="label label-info" href="http://twitter.com/k33g_org/">@k33g_org</a>
    <a class="label label-warning" href="http://feeds.feedburner.com/K33g_orgsBlog">rss</a>
    <a class="label label-info" href="http://k33g.github.com/all.html">all posts</a>
    <a class="label label-warning" href="http://www.k33g.org/">me</a>
</div>
<div class="container">

    <div class="row">
        <div>
    <div>
        <g:plusone size="medium"></g:plusone>
        <a href="https://twitter.com/share" class="twitter-share-button" data-count="horizontal" data-via="k33g_org">Tweet</a><script type="text/javascript" src="//platform.twitter.com/widgets.js"></script>
        <h1>Write CoffeeScript Model Classes like Playframework's Models</h1>

<p>I love how models operate in Playframewok <a href="http://www.playframework.org/documentation/1.2.4/model">http://www.playframework.org/documentation/1.2.4/model</a>. In this article I will try to do the same with Coffeescript.</p>

<p><strong>Warning</strong> : My "POC" works only with recent browsers</p>

<p>So, we are going create a class model step by step.</p>

<h2>Automatically generate properties from public fields</h2>

<pre><code>class Model
  constructor:(args)-&gt;
    fields = Object.keys @
    that = @
    fields.forEach (item) -&gt;
      propertyName = item.toString()
      that["_"+propertyName] = that[propertyName]
      Object.defineProperty that, propertyName,
        get: -&gt;
          console.log "Get : ", propertyName, that["_"+propertyName]
          that["_"+propertyName]
        set: (value)-&gt;
          console.log "Set : ", propertyName, value
          that["_"+propertyName] = value
        enumerable: true
        configurable: true
</code></pre>

<h3>What's going on?</h3>

<ul>
<li>The class constructor parses each field of itself (<code>Object.keys @</code>)</li>
<li>Create (for each field) a new field prefixed with "_"</li>
<li>Create (instead of each field) a property (with the same name)</li>
</ul>


<p>Then, when you write <code>bob.name</code> it's <code>bob._name</code> wich is returned, when you write <code>bob.name="Bob"</code> it's <code>bob._name</code> wich equals <code>"Bob"</code>.</p>

<p><strong>Remark</strong> :</p>

<p>You shoul have noticed that i use : <code>that = @</code>, it's a javascript habit. In fact, it's better using "fat arrow", see <a href="http://jashkenas.github.com/coffee-script/#fat_arrow">http://jashkenas.github.com/coffee-script/#fat_arrow</a>, and then, there is no need to use the artificial <code>that = @</code> :</p>

<pre><code>class Model
  constructor:(args)-&gt;
    fields = Object.keys @

    fields.forEach (item) =&gt;
      propertyName = item.toString()
      @["_"+propertyName] = @[propertyName]
      Object.defineProperty @, propertyName,
        get: =&gt;
          console.log "Get : ", propertyName, @["_"+propertyName]
          @["_"+propertyName]
        set: (value)=&gt;
          console.log "Set : ", propertyName, value
          @["_"+propertyName] = value
        enumerable: true
        configurable: true
</code></pre>

<h3>Use it</h3>

<pre><code>#Human Model
class Human  extends Model
  constructor:(name)-&gt;
    @name = name
    super

#Task Model
class Task extends Model
  constructor:(label)-&gt;
    @label = label
    @priority = "strong"
    super

task1 = new Task "Milk"
task2 = new Task "Butter"

bob = new Human "BOB"
sam = new Human "SAM"

task1.label = "Remember the milk"
bob.name = "Bobby"

console.log sam.name

console.log task1, task2, bob, sam
</code></pre>

<p>I launch this code in a navigator (you can use node.js too if you want), and i get this :</p>

<p><img src="https://github.com/k33g/k33g.github.com/raw/master/images/coffeemods01.png" alt="Alt &quot;coffeemods01.png&quot;" /></p>

<h2>I want to subscribe to "changes"</h2>

<p>This approach is more "javascript/coffescript" than "playframework" but it's interesting for the development of web pages.</p>

<h3>Create a Event class :</h3>

<pre><code>class Event
  @send:(eventName, data)-&gt;
    evt = document.createEvent("Event")
    evt.initEvent eventName, false, false
    evt.data = data
    document.dispatchEvent evt
</code></pre>

<h3>Update the Model class :</h3>

<pre><code>class Model
  constructor:(args)-&gt;
    fields = Object.keys @

    fields.forEach (item) =&gt;
      propertyName = item.toString()
      @["_"+propertyName] = @[propertyName]
      Object.defineProperty @, propertyName,
        get: =&gt;
          console.log "Get : ", propertyName, @["_"+propertyName]
          @["_"+propertyName]
        set: (value)=&gt;
          #save old value
          old = @["_"+propertyName]
          console.log "Set : ", propertyName, value
          @["_"+propertyName] = value

          #fire change event
          Event.send "Change",
            property: propertyName
            newValue : value
            oldValue : old

        enumerable: true
        configurable: true
</code></pre>

<h3>Use it</h3>

<pre><code>#Human Model
class Human  extends Model
  constructor:(name)-&gt;
    @name = name
    super

#Task Model
class Task extends Model
  constructor:(label)-&gt;
    @label = label
    @priority = "strong"
    super


document.addEventListener "Change", ((e) -&gt;
  console.log "Change", e.data
), false

task1 = new Task "Milk"
bob = new Human "BOB"

task1.label = "Remember the milk"
bob.name = "Bobby"
</code></pre>

<p>I launch this code in a navigator, and i get this :</p>

<p><img src="https://github.com/k33g/k33g.github.com/raw/master/images/coffeemods02.png" alt="Alt &quot;coffeemods02.png&quot;" /></p>

<h2>I want a list of models for each child class model</h2>

<p>I mean, if i have a Task class Model, i want something like that : <code>ask.list</code>, if i have a Human class Model, i want : <code>Human.list</code>.</p>

<p>I'll do it this way: in the constructor of the model, I will check if the field list exists for the parent class of the instance. If not, I add it (creepy ? yes a little, but useful).</p>

<p>Therefore, modify our Model class : (see last two lines of the class)</p>

<pre><code>class Model
  constructor:(args)-&gt;
    fields = Object.keys @

    fields.forEach (item) =&gt;
      propertyName = item.toString()
      @["_"+propertyName] = @[propertyName]
      Object.defineProperty @, propertyName,
        get: =&gt;
          console.log "Get : ", propertyName, @["_"+propertyName]
          @["_"+propertyName]
        set: (value)=&gt;
          #save old value
          old = @["_"+propertyName]
          console.log "Set : ", propertyName, value
          @["_"+propertyName] = value

          #fire change event
          Event.send "Change",
            property: propertyName
            newValue : value
            oldValue : old

        enumerable: true
        configurable: true

    #create static list of models
    if not @.__proto__.constructor.list
      @.__proto__.constructor.list = []
</code></pre>

<h3>Add a save method (in memory) to the class Model</h3>

<p>What i want ? If i save a model, it adds itself to the list, if it's a new model, an id (guid) is automatically generated (if not exists) and the model is pushed to the list. If id exists, we check if model exists in the list, if not it is pushed too, if it exists, updates are automatically reflected (the magic of javascript ;) (*) ).</p>

<p>Then, i add a save method and a static guid method (to generate GUID) to the Model class :</p>

<pre><code>  @guid : -&gt;
    S4 = -&gt;
      (((1 + Math.random()) * 0x10000) | 0).toString(16).substring 1
    S4() + S4() + "-" + S4() + "-" + S4() + "-" + S4() + "-" + S4() + S4() + S4()

  save:-&gt;
    list = @.__proto__.constructor.list
    if @id is `undefined` or @id is null or @id is ""
      @id = Model.guid()
      list.push @
    else
      tmp = list.filter((record) =&gt;
        record.id is @.id
      )[0]
      (if not tmp then list.push(@))
    @
</code></pre>

<p>(*) : Once the model was saved (and therefore added to the list), you do not have to call the save method at each change (because it is in memory). But it is good practice, especially if we add persistence capabilities in the local storage, for example.</p>

<h3>Use it</h3>

<pre><code>task1 = new Task "Milk"
task2 = new Task "Beer"

bob = new Human "BOB"
sam = new Human "SAM"

task1.save()
task2.save()
bob.save()
sam.save()

console.log Task.list, Human.list
</code></pre>

<p>I launch this code in a navigator, and i get this :</p>

<p><img src="https://github.com/k33g/k33g.github.com/raw/master/images/coffeemods03.png" alt="Alt &quot;coffeemods03.png&quot;" /></p>

<h3>Add a delete method (in memory) to the class Model</h3>

<pre><code>  delete:-&gt;
    list = @.__proto__.constructor.list
    list.splice list.indexOf(@), 1
    @
</code></pre>

<h2>I want to query my models !!!</h2>

<h3>First all() and fetch() methods</h3>

<p>I add those statics methods to the Model class :</p>

<pre><code>  @all:-&gt;
    @result = @list
    @

  @fetch:-&gt;
    @result
</code></pre>

<h3>Use it</h3>

<pre><code>#get all tasks
Task.all().fetch()

#get all humans
Human.all().fetch()
</code></pre>

<h3>Add a find method</h3>

<p>I add this static method to the Model class :</p>

<pre><code>  @find:(fieldOrFunction, value) -&gt;
     if value
       @result = @list.filter((record) -&gt;
         record[fieldOrFunction] is value
       )
     else
       @result = @list.filter(fieldOrFunction)
     @
</code></pre>

<h3>Use it</h3>

<pre><code>Human.find("name", "SAM").fetch()

Human.find((record) -&gt;
  record.name == "SAM" or record.name == "BOB"
).fetch()
</code></pre>

<h3>Add first, last and from methods</h3>

<p>I add those statics methods to the Model class :</p>

<pre><code>  @first:-&gt;
    @result[0]

  @last:-&gt;
    @result[@result.length-1]

  @from:(from, howmuch) -&gt;
    @_from = from
    if @_from &gt;= 0
      @result = @result.slice(@_from, @_from + howmuch)
      delete @_from
    else
      @result = @result.slice(0, howmuch)  if howmuch &gt;= 0
    @
</code></pre>

<h3>Use it</h3>

<pre><code>bob = new Human "BOB"
sam = new Human "SAM"
peter = new Human "PETER"
clark = new Human "CLARK"

peter.save()
clark.save()
bob.save()
sam.save()

console.log "First Human : ", Human.all().first()
console.log "Last Human : ", Human.all().last()

console.log "First Two Humans from first : ", Human.from(0,2).fetch()
</code></pre>

<p>I launch this code in a navigator, and i get this :</p>

<p><img src="https://github.com/k33g/k33g.github.com/raw/master/images/coffeemods04.png" alt="Alt &quot;coffeemods04.png&quot;" /></p>

<h2>I want to sort my models !!!</h2>

<p>I add this static method to the Model class :</p>

<pre><code>  @orderBy:(what, order) -&gt;
    if @list
      if @list.length &gt; 0
        if typeof @list[0][what] is "string"
          @list.sort (s, t) -&gt;
            a = s[what].toLowerCase()
            b = t[what].toLowerCase()
            return -1  if a &lt; b
            return 1  if a &gt; b
            0

          @list.reverse()  if order is "DESC"
        else
          #numerical sort
          if order is "DESC"
            @list.sort (a, b) -&gt;
              b[what] - a[what]
          else
            @list.sort (a, b) -&gt;
              a[what] - b[what]
    @
</code></pre>

<h3>Use it :</h3>

<pre><code>Human.all().orderBy("name","DESC").fetch()
</code></pre>

<h2>Next time ...</h2>

<p>We will see how to use localstorage of navigator with our models.</p>

        <g:plusone size="medium"></g:plusone>
        <a href="https://twitter.com/share" class="twitter-share-button" data-count="horizontal" data-via="k33g_org">Tweet</a><script type="text/javascript" src="//platform.twitter.com/widgets.js"></script>
    </div>
    <div class="whoring">
        <hr>
        <div id="disqus_thread"></div>
            <script type="text/javascript">
                /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
                var disqus_shortname = 'k33gblog'; // required: replace example with your forum shortname

                var disqus_identifier = 'CoffeeScript Model Classes like Playframework's Models';

                // The following are highly recommended additional parameters. Remove the slashes in front to use.
                // var disqus_identifier = 'unique_dynamic_id_1234';
                // var disqus_url = 'http://example.com/permalink-to-page.html';

                /* * * DON'T EDIT BELOW THIS LINE * * */
                (function() {
                    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
                    dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
                    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
                })();
            </script>
            <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
            <a href="http://disqus.com" class="dsq-brlink">blog comments powered by <span class="logo-disqus">Disqus</span></a>

    </div>


    <div id="related">
        <h2>Related Posts</h2>
            <ul class="posts">
            
              <li><span>10 May 2014</span> &raquo; <a href="/2014/05/10/ATOM-SHELL.html">Atom-shell, javascript everywhere</a></li>
            
              <li><span>09 May 2014</span> &raquo; <a href="/2014/05/09/NPM-NODE-CLI.html">Faites vos outils avec npm et node</a></li>
            
              <li><span>04 May 2014</span> &raquo; <a href="/2014/05/04/MIXIT-2014.html">MixITFR2014</a></li>
            
        </ul>
    </div>
</div>
    </div>

    <div class="row">
        <h3>A voir : Les GROS tutos Play!> 1 & 2 !, Backbone</h3>
        <ul>
            <li>
                <a href="http://3monkeys.github.com/play.rules/livre.play.deux.web/play2.rules.return.html">
                    Play!► 2 en douceur •
                </a>
                <a href="http://3monkeys.github.com/play.rules/livre.play.un.web/play.rules.one.html">
                    Apprendre Play!► 1 •
                </a>
                <a href="http://3monkeys.github.com/play.rules/">
                    Versions epub & pdf
                </a>
            </li>
            <li>
                <a href="http://k33g.github.io/backbone.en.douceur/">
                    Backbone.js "en douceur" •
                </a>
                <a href="http://k33g.github.io/backbone.en.douceur/backbone.en.douceur.20121220.pdf"><b>LE</b> pdf</a>
            </li>
            <li>
                A venir : Golo "dans tous les sens" ♥
            </li>
        </ul>
    </div>
    <hr>

</div>



<!-- Google Analytics -->
<script type="text/javascript">

  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-11383603-5']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();

</script>
<!-- Google Analytics end -->

</body>
</html>