<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us">
<head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>Golo et interopérabilité Java</title>
    <meta name="author" content="k33g" />

    <!-- Homepage CSS -->
    <!--
    <link rel="stylesheet" href="http://twitter.github.io/bootstrap/assets/css/bootstrap.css">
    <link rel="stylesheet" href="/css/screen.css" type="text/css" media="screen, projection" />
	-->

    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1">
    <link href="/bootstrap3/css/bootstrap.css" rel="stylesheet" type="text/css">
    <script type="text/javascript" src="bootstrap3/js/bootstrap.min.js"></script>

    <style>
        .jumbotron {
            background-color: #b8eee9;
            border-radius: 0px;
            padding: 10px 30px;
        }
    </style>

    <!-- syntax highlighting CSS -->
    <link rel="stylesheet" href="/css/syntax.css" type="text/css" />
		<link rel="stylesheet" href="/css/default.min.css">


    <script type="text/javascript" src="https://apis.google.com/js/plusone.js"></script>

</head>

<body >

<div class="jumbotron">
    <a class="label label-warning" href="/">K33G_ORG's Blog</a>
    <a class="label label-info" href="http://twitter.com/k33g_org/">@k33g_org</a>
    <a class="label label-warning" href="http://feeds.feedburner.com/K33g_orgsBlog">rss</a>
    <a class="label label-info" href="http://k33g.github.com/all.html">all posts</a>
    <a class="label label-warning" href="http://www.k33g.org/">me</a>
</div>
<div class="container">

    <div class="row">
        <div>
    <div>
        <g:plusone size="medium"></g:plusone>
        <a href="https://twitter.com/share" class="twitter-share-button" data-count="horizontal" data-via="k33g_org">Tweet</a><script type="text/javascript" src="//platform.twitter.com/widgets.js"></script>
        <h1>Golo et interopérabilité Java par l'exemple avec Jetty, SparkJava et Vert.x</h1>

<p>J'adore dire que <strong>Golo</strong> est de la <strong>"sucrette syntaxique"</strong> pour Java. Ce que je veux dire par là c'est que <strong>Golo</strong> permet non seulement de rendre Java "plus simple" mais aussi <strong>"d'interopérer" facilement</strong> avec Java. C'était le cas depuis le début, mais depuis quelques semaines <strong>Golo</strong> a connu quelques évolutions notables sur le sujet.</p>

<h2>Au début : les Single Method Interfaces</h2>

<p><strong>Golo</strong> sait bien sûr instancier toute sorte d'objets(classes) Java, de l'API Java ou en provenance de librairies(frameworks) Java existants, comme par exemple utiliser <code>com.sun.net.httpserver.HttpServer</code> pour faire un mini serveur http :</p>

<div class="highlight"><pre><code class="coffeescript"><span class="nx">let</span> <span class="nv">server = </span><span class="nx">HttpServer</span><span class="p">.</span><span class="nx">create</span><span class="p">(</span><span class="nx">InetSocketAddress</span><span class="p">(</span><span class="s">&quot;localhost&quot;</span><span class="p">,</span> <span class="mi">8080</span><span class="p">),</span> <span class="mi">0</span><span class="p">)</span>
</code></pre></div>


<p>Mais ensuite si on veut faire bosser notre serveur, nous avons besoin de passer un objet qui <strong>implémente l'interface</strong> <code>HttpHandler</code> à la méthode <code>createContext()</code> de <code>server</code>, en Java nous aurions ceci :</p>

<div class="highlight"><pre><code class="java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Test</span> <span class="o">{</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
        <span class="n">HttpServer</span> <span class="n">server</span> <span class="o">=</span> <span class="n">HttpServer</span><span class="o">.</span><span class="na">create</span><span class="o">(</span><span class="k">new</span> <span class="n">InetSocketAddress</span><span class="o">(</span><span class="mi">8080</span><span class="o">),</span> <span class="mi">0</span><span class="o">);</span>
        <span class="n">server</span><span class="o">.</span><span class="na">createContext</span><span class="o">(</span><span class="s">&quot;/&quot;</span><span class="o">,</span> <span class="k">new</span> <span class="n">MyHandler</span><span class="o">());</span>
        <span class="n">server</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="kd">static</span> <span class="kd">class</span> <span class="nc">MyHandler</span> <span class="kd">implements</span> <span class="n">HttpHandler</span> <span class="o">{</span>
        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">handle</span><span class="o">(</span><span class="n">HttpExchange</span> <span class="n">t</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">IOException</span> <span class="o">{</span>
            <span class="c1">// foo</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div>


<p>Je vous rappelle qu'à ce jour le concept classique de classe n'existe pas, mais il se trouve que <strong>Golo</strong> sait "caster" des closures en <strong>"Single Method Interfaces"</strong> (la doc est par ici : <a href="http://golo-lang.org/documentation/next/#_conversion_to_single_method_interfaces">http://golo-lang.org/documentation/next/#_conversion_to_single_method_interfaces</a>).</p>

<p>Du coup pour avoir notre instance de handler implémentant <code>HttpHandler</code> il nous suffira d'écrire : <code>let handler = |fct| -&gt; fct: to(HttpHandler.class)</code>et notre mini serveur http resemblera à ceci :</p>

<div class="highlight"><pre><code class="coffeescript"><span class="nx">module</span> <span class="nx">http</span><span class="p">.</span><span class="nx">hello</span><span class="p">.</span><span class="nx">world</span>

<span class="nx">import</span> <span class="nx">java</span><span class="p">.</span><span class="nx">net</span><span class="p">.</span><span class="nx">InetSocketAddress</span>
<span class="nx">import</span> <span class="nx">com</span><span class="p">.</span><span class="nb">sun</span><span class="p">.</span><span class="nx">net</span><span class="p">.</span><span class="nx">httpserver</span><span class="p">.</span><span class="nx">HttpHandler</span>
<span class="nx">import</span> <span class="nx">com</span><span class="p">.</span><span class="nb">sun</span><span class="p">.</span><span class="nx">net</span><span class="p">.</span><span class="nx">httpserver</span><span class="p">.</span><span class="nx">HttpServer</span>

<span class="nx">function</span> <span class="nv">main = </span><span class="o">|</span><span class="nx">args</span><span class="o">|</span> <span class="p">{</span>

  <span class="nx">let</span> <span class="nv">handler = </span><span class="o">|</span><span class="nx">fct</span><span class="o">|</span> <span class="nf">-&gt;</span> <span class="nv">fct: </span><span class="nx">to</span><span class="p">(</span><span class="nx">HttpHandler</span><span class="p">.</span><span class="nx">class</span><span class="p">)</span>
  
  <span class="nx">let</span> <span class="nv">server = </span><span class="nx">HttpServer</span><span class="p">.</span><span class="nx">create</span><span class="p">(</span><span class="nx">InetSocketAddress</span><span class="p">(</span><span class="s">&quot;localhost&quot;</span><span class="p">,</span> <span class="mi">8080</span><span class="p">),</span> <span class="mi">0</span><span class="p">)</span>

  <span class="nv">server: </span><span class="nx">createContext</span><span class="p">(</span><span class="s">&quot;/&quot;</span><span class="p">,</span> <span class="nx">handler</span><span class="p">(</span><span class="o">|</span><span class="nx">exchange</span><span class="o">|</span><span class="p">{</span>
    <span class="nx">let</span> <span class="nv">headers = exchange: </span><span class="nx">getResponseHeaders</span><span class="p">()</span>
    <span class="nx">let</span> <span class="nv">uri = exchange: </span><span class="nx">getRequestURI</span><span class="p">()</span><span class="o">:</span> <span class="nx">toString</span><span class="p">()</span>
    <span class="nv">headers: </span><span class="nx">set</span><span class="p">(</span><span class="s">&quot;Content-Type&quot;</span><span class="p">,</span> <span class="s">&quot;text/html&quot;</span><span class="p">)</span>
    <span class="nx">let</span> <span class="nv">response = </span><span class="s">&quot;&lt;h1&gt;Hello Golo&lt;/h1&gt;&quot;</span>
    <span class="nv">exchange: </span><span class="nx">sendResponseHeaders</span><span class="p">(</span><span class="mi">200</span><span class="p">,</span> <span class="nv">response: </span><span class="nx">length</span><span class="p">())</span>
    <span class="nv">exchange: </span><span class="nx">getResponseBody</span><span class="p">()</span><span class="o">:</span> <span class="nx">write</span><span class="p">(</span><span class="nv">response: </span><span class="nx">getBytes</span><span class="p">())</span>
    <span class="nv">exchange: </span><span class="nx">close</span><span class="p">()</span>
  <span class="p">}))</span>

  <span class="nv">server: </span><span class="nx">start</span><span class="p">()</span>
  <span class="c1"># call http://localhost:8080</span>
<span class="p">}</span>
</code></pre></div>


<h2>Je veux faire pareil avec Jetty ! Vive l'AdapterFabric</h2>

<p>La problématique dans le cas de <strong>Jetty</strong>, c'est que le serveur (<code>org.eclipse.jetty.server.Server</code>) a une méthode <code>setHandler()</code> qui "attend" un objet de type <code>org.eclipse.jetty.server.handler.AbstractHandler</code> (donc héritage) qui lui même implémente l'interface <code>Handler</code> (<a href="http://download.eclipse.org/jetty/stable-7/apidocs/org/eclipse/jetty/server/Handler.html">http://download.eclipse.org/jetty/stable-7/apidocs/org/eclipse/jetty/server/Handler.html</a>), donc il va falloir en plus lui écrire une méthode <code>handle()</code>.</p>

<p>Je le répète : le concept de classe n'existe pas en Golo, mais depuis peu nous avons l'<code>AdapterFabric</code> qui permet de créer des "espèces" de proxies dynamiques mais en poussant le concept un peu plus loin puis que l'on peu créer des objets dynamiques pouvant hériter de classe java, pouvant implémenter des interfaces java tout en définissant les méthodes à implémenter voire même en surchargeant les méthodes héritées.</p>

<p>Donc dans le cas de <strong>Jetty</strong>, il faudra définir une "configuration" pour "représenter" <code>AbstractHandler</code> :</p>

<div class="highlight"><pre><code class="coffeescript"><span class="c1"># AbstractHandler</span>
<span class="nx">let</span> <span class="nv">conf = </span><span class="nx">map</span><span class="p">[</span>
  <span class="p">[</span><span class="s">&quot;extends&quot;</span><span class="p">,</span> <span class="s">&quot;org.eclipse.jetty.server.handler.AbstractHandler&quot;</span><span class="p">],</span>
  <span class="p">[</span><span class="s">&quot;implements&quot;</span><span class="p">,</span> <span class="nx">map</span><span class="p">[</span>
    <span class="p">[</span><span class="s">&quot;handle&quot;</span><span class="p">,</span> <span class="o">|</span><span class="k">this</span><span class="p">,</span> <span class="nx">target</span><span class="p">,</span> <span class="nx">baseRequest</span><span class="p">,</span> <span class="nx">request</span><span class="p">,</span> <span class="nx">response</span><span class="o">|</span> <span class="p">{</span>
      <span class="c1"># foo</span>
    <span class="p">}]</span>       
  <span class="p">]]</span>
<span class="p">]</span>
</code></pre></div>


<p>Puis pour instancier notre <code>AbstractHandler</code> il nous suffira d'écrire ceci :</p>

<div class="highlight"><pre><code class="coffeescript"><span class="nx">let</span> <span class="nv">hello_handler = </span><span class="nx">AdapterFabric</span><span class="p">()</span><span class="o">:</span> <span class="nx">maker</span><span class="p">(</span><span class="nx">conf</span><span class="p">)</span><span class="o">:</span> <span class="nx">newInstance</span><span class="p">()</span>
</code></pre></div>


<p>Et enfin notre serveur à base de <strong>Jetty</strong> ressemblera donc à ceci :</p>

<div class="highlight"><pre><code class="coffeescript"><span class="nx">module</span> <span class="nx">hello_handler</span>

<span class="nx">import</span> <span class="nx">javax</span><span class="p">.</span><span class="nx">servlet</span><span class="p">.</span><span class="nx">http</span><span class="p">.</span><span class="nx">HttpServletResponse</span>
<span class="nx">import</span> <span class="nx">org</span><span class="p">.</span><span class="nx">eclipse</span><span class="p">.</span><span class="nx">jetty</span><span class="p">.</span><span class="nx">server</span><span class="p">.</span><span class="nx">Server</span>

<span class="nx">function</span> <span class="nv">main = </span><span class="o">|</span><span class="nx">args</span><span class="o">|</span> <span class="p">{</span>
  
  <span class="nx">let</span> <span class="nv">HelloHandler = </span><span class="p">{</span>
    <span class="nx">let</span> <span class="nv">conf = </span><span class="nx">map</span><span class="p">[</span>
      <span class="p">[</span><span class="s">&quot;extends&quot;</span><span class="p">,</span> <span class="s">&quot;org.eclipse.jetty.server.handler.AbstractHandler&quot;</span><span class="p">],</span>
      <span class="p">[</span><span class="s">&quot;implements&quot;</span><span class="p">,</span> <span class="nx">map</span><span class="p">[</span>
        <span class="p">[</span><span class="s">&quot;handle&quot;</span><span class="p">,</span> <span class="o">|</span><span class="k">this</span><span class="p">,</span> <span class="nx">target</span><span class="p">,</span> <span class="nx">baseRequest</span><span class="p">,</span> <span class="nx">request</span><span class="p">,</span> <span class="nx">response</span><span class="o">|</span> <span class="p">{</span>
          <span class="nv">response: </span><span class="nx">setContentType</span><span class="p">(</span><span class="s">&quot;text/html;charset=utf-8&quot;</span><span class="p">)</span>
          <span class="nv">response: </span><span class="nx">setStatus</span><span class="p">(</span><span class="nx">HttpServletResponse</span><span class="p">.</span><span class="nx">SC_OK</span><span class="p">())</span>
          <span class="nv">baseRequest: </span><span class="nx">setHandled</span><span class="p">(</span><span class="kc">true</span><span class="p">)</span>
          <span class="nv">response: </span><span class="nx">getWriter</span><span class="p">()</span><span class="o">:</span> <span class="nx">println</span><span class="p">(</span><span class="s">&quot;&lt;h1&gt;Golo Rocks&lt;/h1&gt;&quot;</span><span class="p">)</span>
        <span class="p">}]</span>       
      <span class="p">]]</span>
    <span class="p">]</span>
    <span class="k">return</span> <span class="nx">AdapterFabric</span><span class="p">()</span><span class="o">:</span> <span class="nx">maker</span><span class="p">(</span><span class="nx">conf</span><span class="p">)</span><span class="o">:</span> <span class="nx">newInstance</span><span class="p">()</span>
  <span class="p">}</span>

  <span class="nx">let</span> <span class="nv">server = </span><span class="nx">Server</span><span class="p">(</span><span class="mi">8080</span><span class="p">)</span>
  <span class="nv">server: </span><span class="nx">setHandler</span><span class="p">(</span><span class="nx">HelloHandler</span><span class="p">())</span>
 
  <span class="nx">server</span><span class="o">:</span><span class="nx">start</span><span class="p">()</span>
  <span class="nx">server</span><span class="o">:</span><span class="nx">join</span><span class="p">()</span>

<span class="p">}</span>
</code></pre></div>


<p><em>Remarque</em> : l'exemple en Java est par là : <a href="http://wiki.eclipse.org/Jetty/Tutorial/Embedding_Jetty">http://wiki.eclipse.org/Jetty/Tutorial/Embedding_Jetty</a></p>

<h2>Ça marche aussi pour les copains et vive les DSL web !</h2>

<p>Cette nouvelle capacité de <strong>Golo</strong> (l'<code>AdapterFabric</code>) alliée à sa capacité à créer des DSL va nous permettre d'écrire par exemple des DSL REST "à la <strong>Node.js</strong>" à partir de frameworks Java existants, tels <a href="http://www.sparkjava.com/">Spark Java</a> (mon petit préféré) ou même <a href="http://vertx.io/">Vert.x</a>. Voici donc des exemples (qui fonctionnent) pour ces 2 frameworks :</p>

<h3>SparkJava :</h3>

<p>Dans le cas de <strong>Spark</strong> ce qui nous intéresse, c'est le concept de <strong>Route</strong> dont nous définirons la configuration (ci-dessous) pour avoir un objet qui <strong>hérite "dynamiquement" de <code>spark.Route"</code> et qui implémente <code>handle()</code></strong> :</p>

<div class="highlight"><pre><code class="coffeescript"><span class="nx">let</span> <span class="nv">conf = </span><span class="nx">map</span><span class="p">[</span>
  <span class="p">[</span><span class="s">&quot;extends&quot;</span><span class="p">,</span> <span class="s">&quot;spark.Route&quot;</span><span class="p">],</span>
  <span class="p">[</span><span class="s">&quot;implements&quot;</span><span class="p">,</span> <span class="nx">map</span><span class="p">[</span>
    <span class="p">[</span><span class="s">&quot;handle&quot;</span><span class="p">,</span> <span class="o">|</span><span class="k">this</span><span class="p">,</span> <span class="nx">request</span><span class="p">,</span> <span class="nx">response</span><span class="o">|</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nx">method</span><span class="p">(</span><span class="nx">request</span><span class="p">,</span> <span class="nx">response</span><span class="p">)</span>
    <span class="p">}]</span>         
  <span class="p">]]</span>
<span class="p">]</span>
</code></pre></div>


<p><em>Remarque</em> : <strong>Spark</strong> fonctionne sur une base <strong>Jetty</strong> d'où la similarité avec l'exemple précédent.</p>

<p>Et voici notre serveur (avec le DSL dans le corps de <code>main</code>)</p>

<div class="highlight"><pre><code class="coffeescript"><span class="nx">module</span> <span class="nx">spark_java</span>

<span class="nx">import</span> <span class="nx">com</span><span class="p">.</span><span class="nx">fasterxml</span><span class="p">.</span><span class="nx">jackson</span><span class="p">.</span><span class="nx">databind</span><span class="p">.</span><span class="nx">ObjectMapper</span>
<span class="nx">import</span> <span class="nx">spark</span><span class="p">.</span><span class="nx">Request</span>
<span class="nx">import</span> <span class="nx">spark</span><span class="p">.</span><span class="nx">Response</span>
<span class="nx">import</span> <span class="nx">spark</span><span class="p">.</span><span class="nx">Route</span>
<span class="nx">import</span> <span class="nx">spark</span><span class="p">.</span><span class="nx">Spark</span>

<span class="nx">import</span> <span class="nx">java</span><span class="p">.</span><span class="nx">io</span><span class="p">.</span><span class="nx">File</span>

<span class="nx">function</span> <span class="nv">toJsonString = </span><span class="o">|</span><span class="nx">data</span><span class="o">|</span> <span class="p">{</span>
  <span class="nx">let</span> <span class="nv">mapper = </span><span class="nx">ObjectMapper</span><span class="p">()</span>
  <span class="k">return</span> <span class="nx">mapper</span><span class="o">:</span><span class="nx">writeValueAsString</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span>
<span class="p">}</span>

<span class="nx">function</span> <span class="nv">route = </span><span class="o">|</span><span class="nx">uri</span><span class="p">,</span> <span class="nx">method</span><span class="o">|</span> <span class="p">{</span>
  <span class="nx">let</span> <span class="nv">conf = </span><span class="nx">map</span><span class="p">[</span>
    <span class="p">[</span><span class="s">&quot;extends&quot;</span><span class="p">,</span> <span class="s">&quot;spark.Route&quot;</span><span class="p">],</span>
    <span class="p">[</span><span class="s">&quot;implements&quot;</span><span class="p">,</span> <span class="nx">map</span><span class="p">[</span>
      <span class="p">[</span><span class="s">&quot;handle&quot;</span><span class="p">,</span> <span class="o">|</span><span class="k">this</span><span class="p">,</span> <span class="nx">request</span><span class="p">,</span> <span class="nx">response</span><span class="o">|</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">method</span><span class="p">(</span><span class="nx">request</span><span class="p">,</span> <span class="nx">response</span><span class="p">)</span>
      <span class="p">}]</span>         
    <span class="p">]]</span>
  <span class="p">]</span>
  <span class="nx">let</span> <span class="nv">Route = </span><span class="nx">AdapterFabric</span><span class="p">()</span><span class="o">:</span> <span class="nx">maker</span><span class="p">(</span><span class="nx">conf</span><span class="p">)</span><span class="o">:</span> <span class="nx">newInstance</span><span class="p">(</span><span class="nx">uri</span><span class="p">)</span>
  <span class="k">return</span> <span class="nx">Route</span>
<span class="p">}</span>

<span class="nx">function</span> <span class="nv">GET = </span><span class="o">|</span><span class="nx">uri</span><span class="p">,</span> <span class="nx">method</span><span class="o">|</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nx">spark</span><span class="p">.</span><span class="nx">Spark</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">route</span><span class="p">(</span><span class="nx">uri</span><span class="p">,</span> <span class="nx">method</span><span class="p">))</span>
<span class="p">}</span>

<span class="nx">function</span> <span class="nv">POST = </span><span class="o">|</span><span class="nx">uri</span><span class="p">,</span> <span class="nx">method</span><span class="o">|</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nx">spark</span><span class="p">.</span><span class="nx">Spark</span><span class="p">.</span><span class="nx">post</span><span class="p">(</span><span class="nx">route</span><span class="p">(</span><span class="nx">uri</span><span class="p">,</span> <span class="nx">method</span><span class="p">))</span>
<span class="p">}</span>

<span class="nx">function</span> <span class="nv">main = </span><span class="o">|</span><span class="nx">args</span><span class="o">|</span> <span class="p">{</span>

  <span class="nx">externalStaticFileLocation</span><span class="p">(</span><span class="nx">File</span><span class="p">(</span><span class="s">&quot;.&quot;</span><span class="p">)</span><span class="o">:</span><span class="nx">getCanonicalPath</span><span class="p">()</span> <span class="o">+</span> <span class="s">&quot;/public&quot;</span><span class="p">)</span>
  <span class="nx">setPort</span><span class="p">(</span><span class="mi">8888</span><span class="p">)</span>

  <span class="nx">GET</span><span class="p">(</span><span class="s">&quot;/hello&quot;</span><span class="p">,</span> <span class="o">|</span><span class="nx">request</span><span class="p">,</span> <span class="nx">response</span><span class="o">|</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">toJsonString</span><span class="p">(</span><span class="nx">map</span><span class="p">[[</span><span class="s">&quot;message&quot;</span><span class="p">,</span><span class="s">&quot;Hello Golo!&quot;</span><span class="p">]])</span>
  <span class="p">})</span> 

  <span class="nx">GET</span><span class="p">(</span><span class="s">&quot;/salut&quot;</span><span class="p">,</span> <span class="o">|</span><span class="nx">request</span><span class="p">,</span> <span class="nx">response</span><span class="o">|</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nx">toJsonString</span><span class="p">(</span><span class="nx">map</span><span class="p">[[</span><span class="s">&quot;message&quot;</span><span class="p">,</span><span class="s">&quot;Salut Golo!&quot;</span><span class="p">]])</span>
  <span class="p">})</span>

  <span class="nx">GET</span><span class="p">(</span><span class="s">&quot;/test/:id&quot;</span><span class="p">,</span> <span class="o">|</span><span class="nx">request</span><span class="p">,</span> <span class="nx">response</span><span class="o">|</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nx">toJsonString</span><span class="p">(</span><span class="nx">map</span><span class="p">[[</span><span class="s">&quot;message&quot;</span><span class="p">,</span> <span class="nv">request: </span><span class="nx">params</span><span class="p">(</span><span class="s">&quot;:id&quot;</span><span class="p">)</span><span class="o">:</span><span class="nx">toString</span><span class="p">()]])</span>
  <span class="p">})</span>

  <span class="nx">POST</span><span class="p">(</span><span class="s">&quot;/bob&quot;</span><span class="p">,</span> <span class="o">|</span><span class="nx">request</span><span class="p">,</span> <span class="nx">response</span><span class="o">|</span> <span class="p">{</span>
    <span class="nv">response: </span><span class="nx">type</span><span class="p">(</span><span class="s">&quot;application/json&quot;</span><span class="p">)</span>
    <span class="nx">let</span> <span class="nv">resp = request: </span><span class="nx">body</span><span class="p">()</span>
    <span class="k">return</span> <span class="nx">toJsonString</span><span class="p">(</span><span class="nx">resp</span><span class="p">)</span>
  <span class="p">})</span>

<span class="p">}</span>
</code></pre></div>


<h3>Vert.x</h3>

<p>Et un petit dernier pour la route : la version avec <strong>Vert.x</strong> en mode "embedded" qui globalement suit une logique très proche, <strong>sauf que cette fois ci</strong> nous ne créons pas un objet qui <strong>"hérite"</strong> de quelque chose mais un objet qui <strong>"implémente dynamiquement"</strong> une interface <code>org.vertx.java.core.Handler</code>, donc dans ce cas là la configuration sera la suivante :</p>

<div class="highlight"><pre><code class="coffeescript"><span class="nx">let</span> <span class="nv">conf = </span><span class="nx">map</span><span class="p">[</span>
  <span class="p">[</span><span class="s">&quot;interfaces&quot;</span><span class="p">,</span> <span class="p">[</span><span class="s">&quot;org.vertx.java.core.Handler&quot;</span><span class="p">]],</span>
  <span class="p">[</span><span class="s">&quot;implements&quot;</span><span class="p">,</span> <span class="nx">map</span><span class="p">[</span>
    <span class="p">[</span><span class="s">&quot;handle&quot;</span><span class="p">,</span> <span class="o">|</span><span class="k">this</span><span class="p">,</span> <span class="nx">request</span><span class="o">|</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nx">method</span><span class="p">(</span><span class="nx">request</span><span class="p">)</span>
    <span class="p">}]</span>         
  <span class="p">]]</span>
<span class="p">]</span>
</code></pre></div>


<p>Et voici donc notre serveur :</p>

<div class="highlight"><pre><code class="coffeescript"><span class="nx">module</span> <span class="nx">vertx</span>

<span class="nx">import</span> <span class="nx">org</span><span class="p">.</span><span class="nx">vertx</span><span class="p">.</span><span class="nx">java</span><span class="p">.</span><span class="nx">core</span><span class="p">.</span><span class="nx">http</span><span class="p">.</span><span class="nx">RouteMatcher</span>
<span class="nx">import</span> <span class="nx">org</span><span class="p">.</span><span class="nx">vertx</span><span class="p">.</span><span class="nx">java</span><span class="p">.</span><span class="nx">core</span><span class="p">.</span><span class="nx">VertxFactory</span>
<span class="nx">import</span> <span class="nx">com</span><span class="p">.</span><span class="nx">fasterxml</span><span class="p">.</span><span class="nx">jackson</span><span class="p">.</span><span class="nx">databind</span><span class="p">.</span><span class="nx">ObjectMapper</span>
<span class="nx">import</span> <span class="nx">com</span><span class="p">.</span><span class="nx">fasterxml</span><span class="p">.</span><span class="nx">jackson</span><span class="p">.</span><span class="nx">databind</span><span class="p">.</span><span class="nx">JsonNode</span>

<span class="c1"># Json helpers</span>
<span class="nx">function</span> <span class="nv">toJson = </span><span class="o">|</span><span class="nx">o</span><span class="o">|</span> <span class="nf">-&gt;</span> <span class="nx">ObjectMapper</span><span class="p">()</span><span class="o">:</span> <span class="nx">valueToTree</span><span class="p">(</span><span class="nx">o</span><span class="p">)</span>
<span class="nx">function</span> <span class="nv">parse = </span><span class="o">|</span><span class="nx">s</span><span class="o">|</span> <span class="nf">-&gt;</span> <span class="nx">ObjectMapper</span><span class="p">()</span><span class="o">:</span> <span class="nx">readValue</span><span class="p">(</span><span class="nx">s</span><span class="p">,</span> <span class="nx">JsonNode</span><span class="p">.</span><span class="nx">class</span><span class="p">)</span>
<span class="nx">function</span> <span class="nv">fromJson = </span><span class="o">|</span><span class="nx">jsonNode</span><span class="p">,</span> <span class="nx">clazz</span><span class="o">|</span> <span class="nf">-&gt;</span> <span class="nx">ObjectMapper</span><span class="p">()</span><span class="o">:</span> <span class="nx">treeToValue</span><span class="p">(</span><span class="nx">jsonNode</span><span class="p">,</span> <span class="nx">clazz</span><span class="p">)</span>

<span class="c1"># Vert.x handler</span>
<span class="nx">function</span> <span class="nv">handler = </span><span class="o">|</span><span class="nx">method</span><span class="o">|</span> <span class="p">{</span>
  <span class="nx">let</span> <span class="nv">conf = </span><span class="nx">map</span><span class="p">[</span>
    <span class="p">[</span><span class="s">&quot;interfaces&quot;</span><span class="p">,</span> <span class="p">[</span><span class="s">&quot;org.vertx.java.core.Handler&quot;</span><span class="p">]],</span>
    <span class="p">[</span><span class="s">&quot;implements&quot;</span><span class="p">,</span> <span class="nx">map</span><span class="p">[</span>
      <span class="p">[</span><span class="s">&quot;handle&quot;</span><span class="p">,</span> <span class="o">|</span><span class="k">this</span><span class="p">,</span> <span class="nx">request</span><span class="o">|</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">method</span><span class="p">(</span><span class="nx">request</span><span class="p">)</span>
      <span class="p">}]</span>         
    <span class="p">]]</span>
  <span class="p">]</span>
  <span class="nx">let</span> <span class="nv">Handler = </span><span class="nx">AdapterFabric</span><span class="p">()</span><span class="o">:</span> <span class="nx">maker</span><span class="p">(</span><span class="nx">conf</span><span class="p">)</span><span class="o">:</span> <span class="nx">newInstance</span><span class="p">()</span>
  <span class="k">return</span> <span class="nx">Handler</span>
<span class="p">}</span>

<span class="nx">function</span> <span class="nv">main = </span><span class="o">|</span><span class="nx">args</span><span class="o">|</span> <span class="p">{</span>
  
  <span class="nx">let</span> <span class="nv">routeMatcher = </span><span class="nx">RouteMatcher</span><span class="p">()</span>

  <span class="c1">#=== CREATE ===</span>
  <span class="nv">routeMatcher: </span><span class="nx">post</span><span class="p">(</span><span class="s">&quot;/hello&quot;</span><span class="p">,</span> <span class="nx">handler</span><span class="p">(</span><span class="o">|</span><span class="nx">req</span><span class="o">|</span> <span class="p">{</span>
    <span class="nv">req: </span><span class="nx">dataHandler</span><span class="p">(</span><span class="nx">handler</span><span class="p">(</span><span class="o">|</span><span class="nx">buffer</span><span class="o">|</span><span class="p">{</span>
      <span class="nx">println</span><span class="p">(</span><span class="nv">buffer: </span><span class="nx">toString</span><span class="p">())</span>

      <span class="nx">let</span> <span class="nv">message = </span><span class="nx">fromJson</span><span class="p">(</span><span class="nx">parse</span><span class="p">(</span><span class="nv">buffer: </span><span class="nx">toString</span><span class="p">()),</span> <span class="nx">java</span><span class="p">.</span><span class="nx">util</span><span class="p">.</span><span class="nx">HashMap</span><span class="p">.</span><span class="nx">class</span><span class="p">)</span>
      <span class="nv">message: </span><span class="nx">put</span><span class="p">(</span><span class="s">&quot;id&quot;</span><span class="p">,</span><span class="nx">java</span><span class="p">.</span><span class="nx">util</span><span class="p">.</span><span class="nx">UUID</span><span class="p">.</span><span class="nx">randomUUID</span><span class="p">()</span><span class="o">:</span> <span class="nx">toString</span><span class="p">())</span>
      <span class="nv">req: </span><span class="nx">response</span><span class="p">()</span><span class="o">:</span> <span class="nx">end</span><span class="p">(</span><span class="nx">toJson</span><span class="p">(</span><span class="nx">message</span><span class="p">)</span><span class="o">:</span> <span class="nx">toString</span><span class="p">())</span>
    <span class="p">}))</span>
  <span class="p">}))</span>

  <span class="c1">#=== GET ALL ===</span>
  <span class="nv">routeMatcher: </span><span class="nx">get</span><span class="p">(</span><span class="s">&quot;/hello&quot;</span><span class="p">,</span> <span class="nx">handler</span><span class="p">(</span><span class="o">|</span><span class="nx">req</span><span class="o">|</span> <span class="p">{</span>
    <span class="nv">req: </span><span class="nx">response</span><span class="p">()</span><span class="o">:</span> <span class="nx">end</span><span class="p">(</span><span class="nx">toJson</span><span class="p">(</span><span class="nx">map</span><span class="p">[[</span><span class="s">&quot;message&quot;</span><span class="p">,</span> <span class="s">&quot;hello Golo!&quot;</span><span class="p">]])</span><span class="o">:</span> <span class="nx">toString</span><span class="p">())</span>
  <span class="p">}))</span>

  <span class="c1">#=== GET BY ID ===</span>
  <span class="nv">routeMatcher: </span><span class="nx">get</span><span class="p">(</span><span class="s">&quot;/hello/:id&quot;</span><span class="p">,</span> <span class="nx">handler</span><span class="p">(</span><span class="o">|</span><span class="nx">req</span><span class="o">|</span> <span class="p">{</span>
    <span class="nv">req: </span><span class="nx">response</span><span class="p">()</span><span class="o">:</span> <span class="nx">end</span><span class="p">(</span><span class="nx">toJson</span><span class="p">(</span><span class="nx">map</span><span class="p">[[</span><span class="s">&quot;message&quot;</span><span class="p">,</span> <span class="s">&quot;hello Golo! -&gt; &quot;</span> <span class="o">+</span> <span class="nv">req: </span><span class="nx">params</span><span class="p">()</span><span class="o">:</span> <span class="nx">get</span><span class="p">(</span><span class="s">&quot;id&quot;</span><span class="p">)]])</span><span class="o">:</span> <span class="nx">toString</span><span class="p">())</span>
  <span class="p">}))</span>

  <span class="c1"># Catch all - serve the index page and static assets</span>
  <span class="nv">routeMatcher: </span><span class="nx">getWithRegEx</span><span class="p">(</span><span class="s">&quot;.*&quot;</span><span class="p">,</span> <span class="nx">handler</span><span class="p">(</span><span class="o">|</span><span class="nx">req</span><span class="o">|</span> <span class="p">{</span>
    <span class="k">if</span> <span class="nv">req: </span><span class="nx">uri</span><span class="p">()</span><span class="o">:</span> <span class="nx">equals</span><span class="p">(</span><span class="s">&quot;/&quot;</span><span class="p">)</span> <span class="p">{</span>
        <span class="nv">req: </span><span class="nx">response</span><span class="p">()</span><span class="o">:</span> <span class="nx">sendFile</span><span class="p">(</span><span class="s">&quot;public/index.html&quot;</span><span class="p">)</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="nv">req: </span><span class="nx">response</span><span class="p">()</span><span class="o">:</span> <span class="nx">sendFile</span><span class="p">(</span><span class="s">&quot;public&quot;</span><span class="o">+</span><span class="nv">req: </span><span class="nx">uri</span><span class="p">())</span>
    <span class="p">}</span>
  <span class="p">}))</span>

  <span class="nx">let</span> <span class="nv">vertx = </span><span class="nx">VertxFactory</span><span class="p">.</span><span class="nx">newVertx</span><span class="p">()</span>
  <span class="nx">vertx</span><span class="o">:</span><span class="nx">createHttpServer</span><span class="p">()</span><span class="o">:</span><span class="nx">requestHandler</span><span class="p">(</span><span class="nx">routeMatcher</span><span class="p">)</span><span class="o">:</span><span class="nx">listen</span><span class="p">(</span><span class="mi">8888</span><span class="p">)</span>

  <span class="nx">readln</span><span class="p">(</span><span class="s">&quot;listening ...&quot;</span><span class="p">)</span>

<span class="p">}</span>
</code></pre></div>


<h2>Conclusion</h2>

<p>C'était certes rapide, mais vous avez pu voir qu'il était extrêmement facile de se plugger à des frameworks existants et d'en simplifier l'utilisation.</p>

<p>Et bon WE à tous :)</p>

        <g:plusone size="medium"></g:plusone>
        <a href="https://twitter.com/share" class="twitter-share-button" data-count="horizontal" data-via="k33g_org">Tweet</a><script type="text/javascript" src="//platform.twitter.com/widgets.js"></script>
    </div>
    <div class="whoring">
        <hr>
        <div id="disqus_thread"></div>
            <script type="text/javascript">
                /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
                var disqus_shortname = 'k33gblog'; // required: replace example with your forum shortname

                var disqus_identifier = 'Golo et interopérabilité Java';

                // The following are highly recommended additional parameters. Remove the slashes in front to use.
                // var disqus_identifier = 'unique_dynamic_id_1234';
                // var disqus_url = 'http://example.com/permalink-to-page.html';

                /* * * DON'T EDIT BELOW THIS LINE * * */
                (function() {
                    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
                    dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
                    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
                })();
            </script>
            <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
            <a href="http://disqus.com" class="dsq-brlink">blog comments powered by <span class="logo-disqus">Disqus</span></a>

    </div>


    <div id="related">
        <h2>Related Posts</h2>
            <ul class="posts">
            
              <li><span>10 May 2014</span> &raquo; <a href="/2014/05/10/ATOM-SHELL.html">Atom-shell, javascript everywhere</a></li>
            
              <li><span>09 May 2014</span> &raquo; <a href="/2014/05/09/NPM-NODE-CLI.html">Faites vos outils avec npm et node</a></li>
            
              <li><span>04 May 2014</span> &raquo; <a href="/2014/05/04/MIXIT-2014.html">MixITFR2014</a></li>
            
        </ul>
    </div>
</div>
    </div>

    <div class="row">
        <h3>A voir : Les GROS tutos Play!> 1 & 2 !, Backbone</h3>
        <ul>
            <li>
                <a href="http://3monkeys.github.com/play.rules/livre.play.deux.web/play2.rules.return.html">
                    Play!► 2 en douceur •
                </a>
                <a href="http://3monkeys.github.com/play.rules/livre.play.un.web/play.rules.one.html">
                    Apprendre Play!► 1 •
                </a>
                <a href="http://3monkeys.github.com/play.rules/">
                    Versions epub & pdf
                </a>
            </li>
            <li>
                <a href="http://k33g.github.io/backbone.en.douceur/">
                    Backbone.js "en douceur" •
                </a>
                <a href="http://k33g.github.io/backbone.en.douceur/backbone.en.douceur.20121220.pdf"><b>LE</b> pdf</a>
            </li>
            <li>
                A venir : Golo "dans tous les sens" ♥
            </li>
        </ul>
    </div>
    <hr>

</div>



<!-- Google Analytics -->
<script type="text/javascript">

  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-11383603-5']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();

</script>
<!-- Google Analytics end -->

</body>
</html>