<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us">
<head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>stykkekode la suite</title>
    <meta name="author" content="k33g" />

    <!-- Homepage CSS -->
    <!--
    <link rel="stylesheet" href="http://twitter.github.io/bootstrap/assets/css/bootstrap.css">
    <link rel="stylesheet" href="/css/screen.css" type="text/css" media="screen, projection" />
	-->

    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1">
    <link href="/bootstrap3/css/bootstrap.css" rel="stylesheet" type="text/css">
    <script type="text/javascript" src="bootstrap3/js/bootstrap.min.js"></script>

    <style>
        .jumbotron {
            background-color: #b8eee9;
            border-radius: 0px;
        }
    </style>

    <!-- syntax highlighting CSS -->
    <link rel="stylesheet" href="/css/syntax.css" type="text/css" />
	<link rel="stylesheet" href="/css/default.min.css">


    <script type="text/javascript" src="https://apis.google.com/js/plusone.js"></script>

</head>

<body >

<div class="jumbotron">
    <h1>K33G_ORG's Blog</h1>
    <p></p>
    <a class="label label-info" href="/">home</a>
    <a class="label label-info" href="http://twitter.com/k33g_org/">@k33g_org</a>
    <a class="label label-warning" href="http://feeds.feedburner.com/K33g_orgsBlog">rss</a>
    <a class="label label-info" href="http://k33g.github.com/all.html">all posts</a>
</div>
<div class="container">

    <div class="row">
        <div>
    <div>
        <g:plusone size="medium"></g:plusone>
        <a href="https://twitter.com/share" class="twitter-share-button" data-count="horizontal" data-via="k33g_org">Tweet</a><script type="text/javascript" src="//platform.twitter.com/widgets.js"></script>
        <h1>Express.js, le Play!>Framework du Javascript ? La suite ...</h1>

<p>Hier, c'était : <a href="http://k33g.github.com/2012/02/19/EXPRESSJS_IS_PLAY.html">cf. 1ère partie "Express is Play (?)"</a></p>

<p>Aujourd'hui, ce sera l'authentification twitter, mais tout d'abord un peu de cosmétique.</p>

<p>... <strong>Faites vous un café avant, il faut être concentré ;)</strong></p>

<h2>Codemirror</h2>

<p>Etant donné que nous saisissons du markdown, allons jusqu'au bout et proposons un éditeur de code avec un peu de couleur. Pour cela nous allons utiliser CodeMirror, un éditeur de code en js assez sympa à utiliser (et surtout facile à utiliser) : <a href="http://codemirror.net/">http://codemirror.net/</a></p>

<h3>Installation</h3>

<p>Il faut récupérer ici : <a href="https://github.com/marijnh/CodeMirror2">https://github.com/marijnh/CodeMirror2</a></p>

<ul>
<li><code>codemirror.js</code>, que vous aller copier dans <code>public/javascripts</code></li>
<li>le mode markdown de codemirror : <code>markdown.js</code> , que vous aller copier dans <code>public/javascripts</code></li>
<li>ainsi que <code>xml.js</code> (encore dans <code>public/javascripts</code>)</li>
</ul>


<p>puis dans <code>public/stylesheets</code> :</p>

<ul>
<li><code>codemirror.css</code></li>
<li><code>rubyblue.css</code> (le thème)</li>
</ul>


<h3>Utilisation</h3>

<p>Dans <code>/views/layout.ejs</code>, ajouter les références aux feuilles de style :</p>

<pre><code>&lt;html&gt;
    &lt;head&gt;
        &lt;title&gt;styKKeKode&lt;/title&gt;
        &lt;link rel="stylesheet" href="stylesheets/bootstrap.css"&gt;
        &lt;link rel="stylesheet" href="stylesheets/bootstrap-responsive.css"&gt;
        &lt;link rel="stylesheet" href="stylesheets/default.min.css"&gt;
        &lt;link rel="stylesheet" href="stylesheets/codemirror.css"&gt;
        &lt;link rel="stylesheet" href="stylesheets/rubyblue.css"&gt;
        &lt;style type="text/css"&gt;
            body {
                padding-top: 60px;
                padding-bottom: 40px;
            }
            .sidebar-nav {
                padding: 9px 0;
            }
        &lt;/style&gt;
        &lt;style type="text/css"&gt;
            .CodeMirror {border-top: 1px solid gray; border-bottom: 1px solid gray;}
            pre { color:white; }
        &lt;/style&gt;
    &lt;/head&gt;
     &lt;%- body %&gt;
&lt;/html&gt;
</code></pre>

<p><strong>Remarque :</strong> j'ai modifié(surcharché) <code>.CodeMirror</code> (vous n'êtes pas obligé) et changé l'attribut <code>color</code> de <code>pre</code> (il y avait un "conflit de couleurs" avec bootstrap)</p>

<p>On retourne dans <code>/views/index.ejs</code>,</p>

<h4>HTML :</h4>

<p>Dans notre formulaire html, il n'y a pas grand chose qui change, nous allons juste ajouter un "compteur" pour le nombre de caractères à saisir :</p>

<pre><code>&lt;!-- mon formulaire de saisie --&gt;
&lt;div id="snippet-form"&gt;
    &lt;h2&gt;Go ...&lt;/h2&gt;
   &lt;form action="/" class="well"&gt;
        &lt;label&gt;Title : &lt;/label&gt;
        &lt;input id="title" type="text" class="span3" style="width:100%" placeholder="title"/&gt;
        &lt;label&gt;Code Snippet : (with markdown) &lt;/label&gt;
        &lt;textarea id="code" placeholder="code" style="width:100%" rows="5"&gt;&lt;/textarea&gt;

        &lt;!-- on ajoute un compteur --&gt;
            &lt;b&gt;&lt;div id="counter"&gt;0/1455&lt;/div&gt;&lt;/b&gt;
        &lt;!-- --&gt;

        &lt;label&gt;User : &lt;/label&gt;
        &lt;input id="user" type="text" placeholder="user"/&gt;
        &lt;button id="postsnippet" type="submit" class="btn"&gt;Ajouter un Snippet&lt;/button&gt;
        &lt;!--&lt;input type="submit" value="Ajouter un Snippet" /&gt;--&gt;
   &lt;/form&gt;
&lt;/div&gt;
</code></pre>

<h4>Javascript :</h4>

<p>Là on on a un peu plus de boulot :</p>

<p>Premièrement, pensez à ajouter les références au librairies codemirror :</p>

<pre><code>&lt;script src="javascripts/codemirror.js"&gt;&lt;/script&gt;
&lt;script src="javascripts/xml.js"&gt;&lt;/script&gt;
&lt;script src="javascripts/markdown.js"&gt;&lt;/script&gt;
</code></pre>

<p>Ensuite, on ajoute le code nécessaire :</p>

<p>Juste après <code>$(document).ready(function() {</code> ajouter ceci :</p>

<pre><code>//le compteur
var counter = $("#counter");

//une référence à notre bouton d'ajout
var postSnippetButton = $("#postsnippet");

counter.css("color","green");

//on transforme notre textarea en super éditeur de code
window.editor = CodeMirror.fromTextArea(document.getElementById("code"), {
    mode: 'markdown',
    lineNumbers: true,
    matchBrackets: true,
    indentUnit : 4,
    theme: "rubyblue",
    lineWrapping : true,
    //on vérifie que l'on ne saisi pas plus de 1455 caractère
    //il faudra quand même vérifier aussi côté serveur
    onChange : function() {
        counter.html(editor.getValue().length + "/1455");
        if(editor.getValue().length &gt; 1455) {
            counter.css("color","red");
            postSnippetButton.hide();
        } else {
            postSnippetButton.show();
            counter.css("color","green");
        }
    }
});
editor.getScrollerElement().style.height = "170px";
editor.getGutterElement().style.height = "170px";
</code></pre>

<p>Une dernière petite modification : dans notre vue <code>window.SnippetFormView</code>, nous allons modifier le code qui permet de récupérer la saisie faites dans la textarea, puis de vider celle-ci. Remplacez donc :</p>

<ul>
<li><code>code : converter.makeHtml(this.$('#code').val())</code> par <code>code : converter.makeHtml(editor.getValue())</code></li>
<li>et <code>this.$('textarea').val('')</code> par <code>editor.setValue('')</code></li>
</ul>


<p>Et voilà pour la partie cosmétique, si tout va bien vous devriez obtenir ceci :</p>

<p><img src="https://github.com/k33g/k33g.github.com/raw/master/images/express10.png" alt="Alt &quot;express10.png&quot;" /></p>

<h2>Authentification Twitter</h2>

<p>Pour cette partie, je dois reconnaître que cela m'a pris un peu plus de temps. Alors je ne fais pas le tour complet de l'authentification via Twitter, mais ça devrait vous donner assez de billes pour creuser plus loin.
L'objectif de cette partie est le suivant :</p>

<ul>
<li>pouvoir s'authentifier via Twitter</li>
<li>ne pouvoir poster qu'une fois autentifié</li>
</ul>


<h3>Pré-requis</h3>

<p>Nous n'allons pas ré-inventer la roue (je ne suis même pas sûr d'y arriver), pour gérer les sessions et s'authentifier avec un compte de rseau social, il existe l'excellente librairie <strong>everyauth</strong> : <a href="https://github.com/bnoguchi/everyauth">https://github.com/bnoguchi/everyauth</a>. Je n'ai rien fait de génial, je me suis juste inspirré des codes d'exemples <a href="https://github.com/bnoguchi/everyauth/blob/master/example/server.js">https://github.com/bnoguchi/everyauth/blob/master/example/server.js</a> (j'ai juste customisé à ma sauce).</p>

<ul>
<li>aller dans le répertoire de votre application : <code>cd stykkekode</code></li>
<li>tapez la commande <code>npm install everyauth</code></li>
</ul>


<h4>Aller enregistrer son application chez Twitter</h4>

<ul>
<li>aller sur le site des développeurs : <a href="https://dev.twitter.com/">https://dev.twitter.com/</a></li>
<li>"signer" vous</li>
<li>sélectionnez "Create an App" : <a href="https://dev.twitter.com/apps/new">https://dev.twitter.com/apps/new</a></li>
</ul>


<p>Voici comment j'ai rempli les informations :</p>

<ul>
<li>Name : <code>stykkekode_dev</code></li>
<li>Description : <code>tutorial about authentication with express.js</code></li>
<li>Website : <code>http://dev.k33g.org</code> (pour le moment vous n'avez pas à mettre un véritable nom de domaine)</li>
<li>Callback URL : <code>http://dev.k33g.org:3000/auth/twitter/callback</code> (il est important de garder le même nom de domaine)</li>
<li>Acceptez les conditions d'utilisation</li>
<li>Clickez sur "Create your twitter application"</li>
<li>Votre application vient d'être créée</li>
<li>Notez quelque part dans un fichier votre <strong>Consumer key</strong> et votre <strong>Consumer secret</strong></li>
</ul>


<p>Ensuite :</p>

<ul>
<li>Clickez sur "Create my access token"</li>
</ul>


<h4>Paramétrer son poste : "fake http://dev.k33g.org"</h4>

<p>En mode commande, tapez : <code>sudo pico /etc/hosts</code> et ajoutez la ligne suivante :</p>

<pre><code>127.0.0.1       dev.k33g.org
</code></pre>

<p>Et sauvegardez, puis quittez.</p>

<p>Donc à partir de maintenant, si vous lancez votre application : <code>nodemon server.js</code>
et que vous tapez l'url <a href="http://dev.k33g.org:3000/">http://dev.k33g.org:3000/</a> vous serez dirigés sur votre application locale.
Et donc cela va vous permettre de tester le callback de twitter en local</p>

<p>... ça c'est fait.</p>

<p>Retournons maintenant dans le code.</p>

<h3>Déclaration et paramétrage de everyauth</h3>

<p>Nous allons tout d'abord créer un fichier <code>config.js</code> à la racine de l'application. Et nous allons renseigner dans ce fichier les informations nécessaires à la connexion avex Twitter :</p>

<pre><code>module.exports = {
    twit: {
        consumerKey: 'ICI VOTRE CONSUMER KEY'
      , consumerSecret: 'ICI VOTRE CONSUMER SECRET'
    }
};
</code></pre>

<p>Ensuite allons dans <code>server.js</code> :</p>

<p>Ajoutons les références à everyauth et config.js :</p>

<pre><code>var express = require('express')
  , routes = require('./routes')
  , everyauth = require('everyauth')    /* AUTHENTICATION */
  , conf = require('./config');         /* AUTHENTICATION */

everyauth.debug = true;
</code></pre>

<p>Dans la partie "Configuration", modifier de la manière suivante : (on utilise le mécanisme de gestion de session d'everyauth)</p>

<pre><code>app.configure(function(){
    /* === start of authentication === */
    app.use(express.cookieParser());
    app.use(express.session({
        secret:'bobmorane',
        "store":  new express.session.MemoryStore({ reapInterval: 60000 * 10 })
    }));
    app.use(everyauth.middleware());
    /* === end of authentication === */

    app.set('views', __dirname + '/views');
    app.set('view engine', 'jade');
    app.use(express.bodyParser());
    app.use(express.methodOverride());
    app.use(app.router);
    app.use(express.static(__dirname + '/public'));
});
</code></pre>

<p>En fin de fichier juste avant <code>app.listen(3000);</code> ajouter <code>everyauth.helpExpress(app);</code></p>

<pre><code>everyauth.helpExpress(app);
app.listen(3000);
</code></pre>

<h3>Utilisation d'everyauth</h3>

<h4>Modèle "user"</h4>

<p>Premièrement, allez créer un "model" <code>user.js</code> dans le répertoire <code>models</code> avec le code suivant</p>

<pre><code>/* USER MODEL */

var user = function(id, source, sourceUser) {
    console.log("New User : ", id, source);
    this.id;
    this.source = source;
    this.sourceUser = sourceUser;
}

//static members

user.listById = {};
user.twitterListById = {};
/*
    user.list : tous les users quel que soit le mode d'authentification
    user.twitterList : les users authentifiés via twitter
    everyauth permet de nombreux modes d'authentification (google par exemple)
    cela permettra d'ajouter d'autres modes si on le souhaite
 */
user.nextUserId = 0;

//static methods
user.add = function(source, sourceUser) {
    user.nextUserId+=1;
    var authenticatedUser = new user(user.nextUserId, source, sourceUser);
    console.log("#################################");
    console.log(authenticatedUser);
    console.log("#################################");
    user.listById[authenticatedUser.id] = authenticatedUser;
    return authenticatedUser;
};

user.findById = function(id) {
    return user.listById[id];
};

user.findByTwitterId = function(id) {
    return user.twitterListById[id];
};

exports.user = user;
</code></pre>

<h4>Utilisation dans server.js</h4>

<p>Entre <code>var app = module.exports = express.createServer();</code> et <code>app.configure(...)</code> ajoutez :</p>

<pre><code>/* === start of authentication === */

var user = require('./models/user').user;

//toujours surcharger ceci :
everyauth.everymodule
    .findUserById( function (id, callback) {
        callback(null, user.findById(id));
    });

//s'authentifier chez twitter
everyauth
    .twitter
    .consumerKey(conf.twit.consumerKey)
    .consumerSecret(conf.twit.consumerSecret)
    .findOrCreateUser( function (sess, accessToken, accessSecret, twitUser) {

        var tmp = user.findByTwitterId(twitUser.id);
        if(tmp) {
            // ne rien faire
        } else {
            tmp = user.add('twitter', twitUser);
            user.twitterListById[twitUser.id] = tmp;
        }

        return tmp;
    })
    .redirectPath('/'); //une fois authentifié rediriger vers "/"


/* === end of authentication === */
</code></pre>

<h4>Utilisation dans la vue index.ejs</h4>

<p>Ajoutons un peu de code à notre vue juste après <code>&lt;div class="container"&gt;</code> :</p>

<script src="https://gist.github.com/1914862.js"> </script>


<p>Donc si vous n'êtes pas authentifié dans twitter, cela vous affichera un lien pour aller vous connecter. Une fois authentifié cela affichera les infos twitter de votre compte. On teste :</p>

<ul>
<li>relancez votre application : <code>nodemon server.js</code></li>
<li>si vous êtes connecté à twitter dans votre navigateur, déconnectez vous (c'est mieux pour le test)</li>
</ul>


<p>Vous devriez obtenir ceci :</p>

<p><img src="https://github.com/k33g/k33g.github.com/raw/master/images/express11.png" alt="Alt &quot;express11.png&quot;" /></p>

<p>Authentifiez vous :</p>

<p><img src="https://github.com/k33g/k33g.github.com/raw/master/images/express12.png" alt="Alt &quot;express12.png&quot;" /></p>

<p>Vous êtes redirigé vers votre application :</p>

<p><img src="https://github.com/k33g/k33g.github.com/raw/master/images/express13.png" alt="Alt &quot;express13.png&quot;" /></p>

<p>C'est cool ça fonctionne (en tous cas chez moi, c'est ok) mais ce n'est pas beau.</p>

<h3>Derniers réglages</h3>

<p>Toujours dans <code>index.ejs</code> on modifie le code précédent :</p>

<script src="https://gist.github.com/1914881.js"> </script>


<p>Puis, vous modifiez le code html pour ne permettre de poster qu'une fois authentifié (le bouton n'apparaît que si vous êtes authentifié) :</p>

<script src="https://gist.github.com/1914883.js"> </script>


<p>Et pensez à déactiver le "vidage" des zones de texte (on veut conserver le pseudo utilisateur) :</p>

<pre><code>//this.$('input[type="text"]').val('');
</code></pre>

<p>et remplacez par :</p>

<pre><code>this.$('#title').val('');
</code></pre>

<p>(oui, je sais, les id cémal)</p>

<p>Et enfin, vous pouvez testez : juste raffraîchir la page, ça devrait suffire : <strong>Tada !!!</strong></p>

<p><img src="https://github.com/k33g/k33g.github.com/raw/master/images/express14.png" alt="Alt &quot;express14.png&quot;" /></p>

<p>Voilà, vous avez de quoi vous amuser. Vous pouvez tester l'application en vrai ici : <a href="http://stykkekode.cloudno.de/">http://stykkekode.cloudno.de/</a>.</p>

<p>Et pour la prochaine fois, nous verrons comment utiliser <strong>CouchDB</strong> pour sauvegarder et retrouver les messages.</p>

<p>Bon dimanche à tous.</p>

        <g:plusone size="medium"></g:plusone>
        <a href="https://twitter.com/share" class="twitter-share-button" data-count="horizontal" data-via="k33g_org">Tweet</a><script type="text/javascript" src="//platform.twitter.com/widgets.js"></script>
    </div>
    <div class="whoring">
        <hr>
        <div id="disqus_thread"></div>
            <script type="text/javascript">
                /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
                var disqus_shortname = 'k33gblog'; // required: replace example with your forum shortname

                var disqus_identifier = 'stykkekode la suite';

                // The following are highly recommended additional parameters. Remove the slashes in front to use.
                // var disqus_identifier = 'unique_dynamic_id_1234';
                // var disqus_url = 'http://example.com/permalink-to-page.html';

                /* * * DON'T EDIT BELOW THIS LINE * * */
                (function() {
                    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
                    dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
                    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
                })();
            </script>
            <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
            <a href="http://disqus.com" class="dsq-brlink">blog comments powered by <span class="logo-disqus">Disqus</span></a>

    </div>


    <div id="related">
        <h2>Related Posts</h2>
            <ul class="posts">
            
              <li><span>10 Dec 2013</span> &raquo; <a href="/2013/12/10/POLYMER-2.html">Polymer 1er contact le retour</a></li>
            
              <li><span>07 Dec 2013</span> &raquo; <a href="/2013/12/07/POLYMER-1.html">Polymer 1er contact</a></li>
            
              <li><span>29 Nov 2013</span> &raquo; <a href="/2013/11/29/BBOM.html">Le modèle objet de Backbone</a></li>
            
        </ul>
    </div>
</div>
    </div>

    <div class="row">
        <h3>A voir : Les GROS tutos Play!> 1 & 2 !, Backbone</h3>
        <ul>
            <li>
                <a href="http://3monkeys.github.com/play.rules/livre.play.deux.web/play2.rules.return.html">
                    Play!► 2 en douceur •
                </a>
                <a href="http://3monkeys.github.com/play.rules/livre.play.un.web/play.rules.one.html">
                    Apprendre Play!► 1 •
                </a>
                <a href="http://3monkeys.github.com/play.rules/">
                    Versions epub & pdf
                </a>
            </li>
            <li>
                <a href="http://k33g.github.io/backbone.en.douceur/">
                    Backbone.js "en douceur" •
                </a>
                <a href="http://k33g.github.io/backbone.en.douceur/backbone.en.douceur.20121220.pdf"><b>LE</b> pdf</a>
            </li>
            <li>
                A venir : Golo "dans tous les sens" ♥
            </li>
        </ul>
    </div>
    <hr>

</div>



<!-- Google Analytics -->
<script type="text/javascript">

  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-11383603-5']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();

</script>
<!-- Google Analytics end -->

</body>
</html>