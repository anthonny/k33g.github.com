<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us">
<head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>Express.js comme PlayFramework</title>
    <meta name="author" content="k33g" />

    <!-- Homepage CSS -->
    <!--
    <link rel="stylesheet" href="http://twitter.github.io/bootstrap/assets/css/bootstrap.css">
    <link rel="stylesheet" href="/css/screen.css" type="text/css" media="screen, projection" />
	-->

    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1">
    <link href="/bootstrap3/css/bootstrap.css" rel="stylesheet" type="text/css">
    <script type="text/javascript" src="bootstrap3/js/bootstrap.min.js"></script>

    <style>
        .jumbotron {
            background-color: #444444;
            border-radius: 0px;
            padding: 10px 30px;
        }
    </style>

    <!-- syntax highlighting CSS -->
    <link rel="stylesheet" href="/css/syntax.css" type="text/css" />
		<link rel="stylesheet" href="/css/default.min.css">


    <script type="text/javascript" src="https://apis.google.com/js/plusone.js"></script>

</head>

<body >

<div class="jumbotron">
    <a class="label label-warning" href="/">K33G_ORG's Blog</a>
    <a class="label label-info" href="http://twitter.com/k33g_org/">@k33g_org</a>
    <a class="label label-warning" href="http://feeds.feedburner.com/K33g_orgsBlog">rss</a>
    <a class="label label-info" href="http://k33g.github.com/all.html">all posts</a>
    <a class="label label-warning" href="http://www.k33g.org/">me</a>
</div>
<div class="container">

    <div class="row">
        <div>
    <div>
        <g:plusone size="medium"></g:plusone>
        <a href="https://twitter.com/share" class="twitter-share-button" data-count="horizontal" data-via="k33g_org">Tweet</a><script type="text/javascript" src="//platform.twitter.com/widgets.js"></script>
        <h1>Express.js, le Play!>Framework du Javascript ?</h1>

<p>Pas tout seul, mais en lui ajoutant 2 ou 3 petites choses, on s'en approche.</p>

<h2>Introduction</h2>

<p>Pour démontrer ce que j'ai écrit dans mon titre, je vais "réaliser" une application à l'aide de :</p>

<ul>
<li>Node.js</li>
<li>Express.js</li>
<li>Backbone.js</li>
<li>... et d'autres, mais vous verrez ça plus loin</li>
</ul>


<p>Cette application, permettra (pour cette fois) :</p>

<ul>
<li>de saisir des messages en markdown avec la possibilité de coloriser les portions de codes présentes dans les messages</li>
<li>de garder ces messages en mémoire (je vais simuler un système de persistance en mémoire, mais je ré-initialise tous les 5 messages)</li>
</ul>


<p>Donc, nous allons :</p>

<ul>
<li>créer des routes, des vues, des modèles, …</li>
<li>faire des requêtes de types REST, avec des POST, PUT, GET, DELETE</li>
</ul>


<p>Si vous arrivez au bout, vous aurez de quoi vous amuser. Et je tenterais d'aller plus loin pour les prochains articles (cf. fin de cet article).</p>

<p><em>Par avance, désolé, je ne fait aucune gestion d'erreur, j'utilise les id dans mon code html, etc. …</em></p>

<p>Bon, on s'y colle. J'ai appelé mon application <strong>stykkekode</strong> qui veut dire "bout de code" en norvégien.</p>

<h2>Installation côté serveur</h2>

<h3>Pré-requis</h3>

<p>Tout d'abord, vous devez installer <strong>Nodejs</strong> : <a href="http://nodejs.org/#download">http://nodejs.org/#download</a>, l'installeur en profite pour installer <strong>npm</strong> (node package manager), ce qui nous permettra d'installer le reste des composants.</p>

<p>Une fois <strong>Nodejs</strong> installé, nous allons installer <strong>Express.js</strong> (<a href="http://expressjs.com/">http://expressjs.com/</a>), "petit" framework un peu dans le même esprit que <strong>Play!></strong> qui permet de générer des applications web sous <strong>Nodejs</strong>.</p>

<p>Pour installer <strong>Express.js</strong>, ouvrez un terminal et tapez la commande suivante :</p>

<pre><code>npm install -g express
</code></pre>

<p>Ensuite nous allons générer le squelette de notre application :</p>

<pre><code>express stykkekode
</code></pre>

<p>Puis installer les dépendances :</p>

<pre><code>cd stykkekode
npm install -d
</code></pre>

<p>Puis installer le moteur de template <strong>ejs</strong> : (express "arrive" avec le moteur <strong>jade</strong>, mais <strong>ejs</strong> à l'avantage de permettre l'utilisation de code html, ce qui permet de ne pas être trop perdu)</p>

<pre><code>npm install ejs
</code></pre>

<p>Ensuite, je vous conseille d'installer <strong>nodemon</strong> (<a href="https://github.com/remy/nodemon">https://github.com/remy/nodemon</a>) qui démarre, arrête et redémarre automatiquement pour vous, votre application à chaque fois qu'il détecte un changement dans le code source (en fait à chaque fois que vous sauvegardez).</p>

<p><strong>Express.js</strong> a généré pour vous tout le squelette et le code de départ de votre application (vous irez voir par vous même l'arborescence générée), pour lancer votre application il faudra, dans le répertoire de celle ci, tapez la commande <code>nodemon app.js</code>, où <code>app.js</code> et le script principal généré par <strong>Express.js</strong>.</p>

<p><strong>WARNING :</strong> Dans le reste de l'article, je l'ai renommé <code>server.js</code> (c'est pour une question technique d'hébergement que je suis en train de tester). Donc vous même, n'oubliez pas de renommer <code>app.js</code> en <code>server.js</code>.</p>

<p>Voilà, voilà, nous pouvons commencer.</p>

<h2>1ère view &amp; 1ère route … 1er contrôleur</h2>

<p>Aller dans le répertoire <code>views</code>, et créer 2 fichiers <code>index.ejs</code> et <code>layout.ejs</code></p>

<p>Dans <code>layout.ejs</code> saisissez le code suivant :</p>

<pre><code>&lt;html&gt;
    &lt;head&gt;
        &lt;title&gt;styKKeKode&lt;/title&gt;
    &lt;/head&gt;
    &lt;%- body %&gt;
&lt;/html&gt;
</code></pre>

<p>Dans <code>index.ejs</code> saisissez le code suivant :</p>

<pre><code>&lt;H1&gt;styKKeKode&lt;/H1&gt;

&lt;% if (message) { %&gt;
    &lt;h2&gt;&lt;%= message %&gt;&lt;/h2&gt;
&lt;% } %&gt;
</code></pre>

<p>si vous allez dans <code>server.js</code> (ou <code>app.js</code>) vous trouverez la ligne suivante :</p>

<pre><code>app.get('/', routes.index);
</code></pre>

<p>Qu'est ce que ça fait ? Dès que vous appeler votre "domaine" dans l'url (la page principale) c'est la méthode <code>index</code> de <code>routes</code> qui est appelée. Et vous trouvez l'implémentation de cette méthode dans <code>/routes/index.js</code>, que nous allons tout de suite modifier.
Remplacer le code de <code>/routes/index.js</code> par :</p>

<pre><code>/*
 * GET home page.
 */

exports.index = function(req, res){
  res.render('index.ejs', { message : 'soon …' })
};
</code></pre>

<p>On peut considérer que c'est l'équivalent de nos contrôleurs Java.</p>

<p>Donc à chaque appel de <code>http://localhost:3000/</code> vous serez redirigé vers la view/vue <code>index.ejs</code>. <strong>Et on passe la variable message à la vue index.ejs</strong>. Vous notez que je précise l'extension de la vue, cela signifie que l'on peut utiliser plusieurs moteurs de template dans la même application.</p>

<p>Pour essayer :</p>

<ul>
<li>ouvrez un terminal, positionnez vous dans le répertoire de votre application et tapez : <code>nodemon server.js</code></li>
<li>appelez <code>http://localhost:3000/</code> dans votre navigateur</li>
</ul>


<p>Nous avons donc rapidement vu les aspects, routes, vue et contrôleur, nous reviendrons plus en détail dessus, mais maintenant, allons un peu plus loin dans la construction de notre "stack".</p>

<h2>Installer les librairies javascript</h2>

<p>… Cela va nous servir pour plus tard</p>

<p>Dans le répertoire <code>public/javascripts</code> copiez les librairies suivantes :</p>

<ul>
<li><code>underscore.js</code>, nécessaire pour faire tourner <code>backbone.js</code> : <a href="http://documentcloud.github.com/underscore/">http://documentcloud.github.com/underscore/</a></li>
<li>jquery.js : <a href="http://docs.jquery.com/Downloading_jQuery">http://docs.jquery.com/Downloading_jQuery</a></li>
<li><code>backbone.js</code> : <a href="http://documentcloud.github.com/backbone/">http://documentcloud.github.com/backbone/</a></li>
<li><code>tempo.js</code> : moteur de template côté client, simple, mais puissant (+ que mustache) : <a href="http://tempojs.com/">http://tempojs.com/</a></li>
<li><code>showdown.js</code> : qui permet de transformer des chaînes au format markdown en code html <a href="https://github.com/coreyti/showdown/tree/master/src">https://github.com/coreyti/showdown/tree/master/src</a></li>
<li><code>highlight.min.js</code> : librairie magique qui permet de "coloriser" le code dans les pages html <a href="http://softwaremaniacs.org/soft/highlight/en/">http://softwaremaniacs.org/soft/highlight/en/</a></li>
</ul>


<p>Dans le répertoire <code>public/stylesheets</code> copiez les css suivantes :</p>

<ul>
<li><code>bootstrap.css</code> (<a href="http://twitter.github.com/bootstrap/">http://twitter.github.com/bootstrap/</a>)</li>
<li>ainsi que <code>bootstrap-responsive.css</code></li>
<li><code>default.min.css</code> la  feuille de style qui "vient" avec <code>highlight.min.js</code></li>
</ul>


<p>Twitter Bootstrap nous permettra de donner une "bonne tête" à notre application, sans effort.</p>

<p>Allons ensuite déclarer les librairies javascript dans <code>views/index.ejs</code> :</p>

<pre><code>&lt;H1&gt;styKKeKode&lt;/H1&gt;

&lt;% if (message) { %&gt;
    &lt;h2&gt;&lt;%= message %&gt;&lt;/h2&gt;
&lt;% } %&gt;


&lt;!-- js libs client --&gt;
&lt;script src="javascripts/jquery.js"&gt;&lt;/script&gt;
&lt;script src="javascripts/underscore.js"&gt;&lt;/script&gt;
&lt;script src="javascripts/backbone.js"&gt;&lt;/script&gt;
&lt;script src="javascripts/tempo.js"&gt;&lt;/script&gt;
&lt;script src="javascripts/showdown.js"&gt;&lt;/script&gt;
</code></pre>

<p>Puis les feuilles de styles dans <code>views/layout.ejs</code> :</p>

<pre><code>&lt;html&gt;
    &lt;head&gt;
        &lt;title&gt;styKKeKode&lt;/title&gt;
        &lt;link rel="stylesheet" href="stylesheets/bootstrap.css"&gt;
        &lt;link rel="stylesheet" href="stylesheets/bootstrap-responsive.css"&gt;
        &lt;link rel="stylesheet" href="stylesheets/default.min.css"&gt;
        &lt;style type="text/css"&gt;
            body {
                padding-top: 60px;
                padding-bottom: 40px;
            }
            .sidebar-nav {
                padding: 9px 0;
            }
        &lt;/style&gt;
    &lt;/head&gt;
     &lt;%- body %&gt;
&lt;/html&gt;
</code></pre>

<h2>Les modèles</h2>

<p>On ne vas pas s'occuper tout de suite de la persistance, mais nous allons créer des modèles et simuler cette persistance dans un 1er temps.</p>

<p>Créer dans votre répertoire applicatif un répertoire <code>models</code> sans lequel vous allez ajouter un fichier <code>snippet.js</code> qui sera donc notre modèle, avec le code suivant :</p>

<pre><code>/* SNIPPET MODEL */
var snippetsCounter = 1;

var snippet = function(title, code, user) {
    this.id = null;
    this.title = title ? title : "";
    this.code = code ? code : "";
    this.user = user ? user : "";
}

//static
snippet.list = [];

snippet.prototype.save = function(callBack) {
    if(this.id === undefined || this.id === null || this.id === "") {
    //new snippet to save

        //Je ré-initialise tous les 5 snippets
        if(snippetsCounter &gt; 5) {
            snippet.list = [];
            snippetsCounter = 1;
        }

        this.id = snippetsCounter++;

        snippet.list.push(this)
    } else {//snippet exists =&gt; to be updated in list
        var
            that = this,
            tmp = snippet.list.filter(function(record){ return record.id === that.id; })[0];
            if(tmp){
                snippet.list.splice(snippet.list.indexOf(this), 1);
                snippet.list.push(this) ;
            }
    }

    callBack(this);
};

snippet.prototype.delete = function(callBack) {
    var
        that = this,
        tmp = snippet.list.filter(function(record){ return record.id === that.id; })[0];
        if(tmp){
            snippet.list.splice(snippet.list.indexOf(this), 1);
        }
    callBack(this);
}

//static
snippet.findAll = function(callBack) {
    callBack(snippet.list);
}

//static
snippet.findById = function(id, callBack) {
    var tmp = snippet.list.filter(function(record){ return record.id === id; })[0];
    console.log("snippet.findById", tmp)
    callBack(tmp);
}


/*=== Bootstrap with data ===*/

var snippet_one = new snippet("essai 1","//FOO","k33g_org");
var snippet_tow = new snippet("essai 2","//Hello World","k33g_org");
var snippet_three = new snippet("essai 3","//Me again !","k33g_org");

snippet_one.save(function(m){console.log(m);});
snippet_tow.save(function(m){console.log(m);});
snippet_three.save(function(m){console.log(m);});

exports.snippet = snippet;
</code></pre>

<p>Dans <code>routes/index.js</code>, ajoutez la ligne suivante en tout début de fichier (on fait un include) :</p>

<pre><code>var snippet = require('../models/snippet').snippet;
</code></pre>

<p>Sauvegardez. Si votre application tourne encore (sinon relancez) vous pourrez voir dans la console la liste des données "bootstrapées".</p>

<p><img src="https://github.com/k33g/k33g.github.com/raw/master/images/express01.png" alt="Alt &quot;express01.png&quot;" /></p>

<p>Maintenant allons écrire quelques routes et contrôleur(s)</p>

<h2>Routes et Contrôleurs</h2>

<h3>Routes</h3>

<p>Préparons le travail pour Backbone.</p>

<p>Allez dans <code>server.js</code> (ou <code>app.js</code>) et copiez les routes suivantes (juste après <code>app.get('/', routes.index);</code>) :</p>

<pre><code>app.post("/snippet", routes.createSnippet);
app.put("/snippet", routes.updateSnippet);
app.get("/snippet", routes.getSnippet);
app.del("/snippet", routes.deleteSnippet);

app.get("/snippets", routes.allSnippets);
</code></pre>

<h3>Contrôleurs</h3>

<p>Allez dans <code>routes/index.js</code> et modifiez le code comme ceci :</p>

<pre><code>var snippet = require('../models/snippet').snippet;

/*
 * GET home page.
 */

exports.index = function(req, res){
  res.render('index.ejs', { message : 'soon …' });
};


exports.createSnippet = function(req, res) {
    console.log("CREATE SNIPPET");

    var model_from_client = JSON.parse(req.param("model", null));
    console.log(model_from_client);

    var server_model = new snippet(model_from_client.title, model_from_client.code, model_from_client.user);

    server_model.save(function(m){
        console.log(m);
        res.json(m);
    });

};

exports.updateSnippet = function(req, res) {
    console.log("UPDATE SNIPPET");

    var model_from_client = JSON.parse(req.param("model", null));
    console.log(model_from_client);

    var server_model = new snippet(model_from_client.title, model_from_client.code, model_from_client.user);

    server_model.id = model_from_client.id;

    server_model.save(function(m){
        console.log(m);
        res.json(m);
    });


};

exports.getSnippet = function(req, res) {
    console.log("GET SNIPPET");

    var model_from_client = JSON.parse(req.param("model", null));
    console.log(model_from_client);

    var server_model = snippet.findById(model_from_client.id, function(m) {
        console.log(m);
        res.json(m);
    });

};

exports.deleteSnippet = function(req, res) {
    console.log("DELETE SNIPPET");
    var model_from_client = JSON.parse(req.param("model", null));
    console.log(model_from_client);

    var server_model = snippet.findById(model_from_client.id, function(model) {
        console.log(model);

        model.delete(function(m){
            res.json(m);
        });
    });


};

exports.allSnippets = function(req, res) {
    console.log("ALL SNIPPETS");

    snippet.findAll(function(snippets){
        res.json(snippets);
    });
};
</code></pre>

<h3>Testons :</h3>

<p>Allez dans votre navigateur, ouvrez la console, et essayez les commandes suivantes :</p>

<h4>createSnippet</h4>

<pre><code>$.ajax({
    type: "POST",
    url: "/snippet",
    data: {"model":JSON.stringify({
        title:"Hello World in Kotlin",
        code : "println('Hello world')",
        user : "@BobMorane"
    })},
    dataType: 'json',
    error: function () {
        console.log("oups");
    },
    success: function (dataFromServer) {
        console.log(dataFromServer);
    }
});
</code></pre>

<p><img src="https://github.com/k33g/k33g.github.com/raw/master/images/express02.png" alt="Alt &quot;express02.png&quot;" /></p>

<p>on peut voir que le serveur nous a affecté un id</p>

<h4>updateSnippet</h4>

<pre><code>$.ajax({
    type: "PUT",
    url: "/snippet",
    data: {"model":JSON.stringify({
        id : 4, /*vérifier que l'id existe*/
        title:"Hello World in Kotlin",
        code : "println('Hello world $name')",
        user : "@BOBMORANE"
    })},
    dataType: 'json',
    error: function () {
        console.log("oups");
    },
    success: function (dataFromServer) {
        console.log(dataFromServer);
    }
});
</code></pre>

<p><img src="https://github.com/k33g/k33g.github.com/raw/master/images/express03.png" alt="Alt &quot;express03.png&quot;" /></p>

<p>Le serveur nous a renvoyé notre modèle modifié</p>

<h4>getSnippet</h4>

<pre><code>$.ajax({
    type: "GET",
    url: "/snippet",
    data: {"model":JSON.stringify({id:1})},
    dataType: 'json',
    error: function () {
        console.log("oups");
    },
    success: function (dataFromServer) {
        console.log(dataFromServer);
    }
});
</code></pre>

<p><img src="https://github.com/k33g/k33g.github.com/raw/master/images/express04.png" alt="Alt &quot;express04.png&quot;" /></p>

<p>Le serveur nous a renvoyé le modèle ayant l'id 1</p>

<h4>deleteSnippet</h4>

<pre><code>$.ajax({
    type: "DELETE",
    url: "/snippet",
    data: {"model":JSON.stringify({id:1})},
    dataType: 'json',
    error: function () {
        console.log("oups");
    },
    success: function (dataFromServer) {
        console.log(dataFromServer);
    }
});
</code></pre>

<p><img src="https://github.com/k33g/k33g.github.com/raw/master/images/express05.png" alt="Alt &quot;express05.png&quot;" /></p>

<p>Et maintenant nous allons appeler la liste de l'ensemble de nos "snippets" pour vérifier que nos modifications ont bien été prises en compte.</p>

<h4>allSnippets</h4>

<pre><code>$.ajax({
    type: "GET",
    url: "/snippets",
    data: null,
    dataType: 'json',
    error: function () {
        console.log("oups");
    },
    success: function (dataFromServer) {
        dataFromServer.forEach(function(model){
            console.log(model)
        });
    }
});
</code></pre>

<p><img src="https://github.com/k33g/k33g.github.com/raw/master/images/express06.png" alt="Alt &quot;express06.png&quot;" /></p>

<h2>Mise en musique avec BackBone.js</h2>

<h3>On re-écrit Backbone.sync</h3>

<p>Vous devez donc créer un fichier <code>backbone.sync.js</code> au même endroit que <code>backbone.js</code> :</p>

<pre><code>(function() {
    Backbone.sync = function(method, model, options) {

        // sympa pour comprendre ce qu'il se passe
        console.log(method, model, options);

        var methodMap = {
            'create': 'POST',
            'update': 'PUT',
            'delete': 'DELETE',
            'read':   'GET'
        }, dataForServer = null;

        if(model.models) {//c'est une collection
            dataForServer:null
        } else {//c'est un modèle

            dataForServer = { model : JSON.stringify(model.toJSON()) };

            console.log(dataForServer);
        }

        return $.ajax({
            type: methodMap[method],
            url: model.url,
            data: dataForServer,
            dataType: 'json',
            error: function (dataFromServer) { //vérifier que cela retourne une erreur
                options.error(dataFromServer);
            },
            success: function (dataFromServer) {
                if(!model.models){
                    dataFromServer.id = dataFromServer._id;
                    console.log(dataFromServer);
                } else {
                    //collection
                    dataFromServer.reverse();
                }
                options.success(dataFromServer);
            }
        });
    };
})();
</code></pre>

<p>Il faudra penser à ajouter dans 'index.ejs' :</p>

<pre><code>&lt;script src="javascripts/backbone.sync.js"&gt;&lt;/script&gt;
</code></pre>

<p>Nous allons donc modifier la vue <code>index.ejs</code> :</p>

<h3>HTML</h3>

<pre><code>&lt;!-- ma barre de titre --&gt;
&lt;div class="navbar navbar-fixed-top"&gt;
    &lt;div class="navbar-inner"&gt;
        &lt;div class="container"&gt;

            &lt;a class="brand" href="#"&gt;styKKeKode
                &lt;% if (message) { %&gt;
                    &lt;%= message %&gt;
                &lt;% } %&gt;
            &lt;/a&gt;

        &lt;/div&gt;
    &lt;/div&gt;
&lt;/div&gt;

&lt;div class="container"&gt;

    &lt;!-- mon formulaire de saisie --&gt;
    &lt;div id="snippet-form"&gt;
        &lt;h2&gt;Go ...&lt;/h2&gt;
       &lt;form action="/" class="well"&gt;
            &lt;label&gt;Title : &lt;/label&gt;
            &lt;input id="title" type="text" class="span3" placeholder="title"/&gt;
            &lt;label&gt;Code Snippet : (with markdown) &lt;/label&gt;
            &lt;textarea id="code" placeholder="code" style="width:100%" rows="5"&gt;&lt;/textarea&gt;
            &lt;label&gt;User : &lt;/label&gt;
            &lt;input id="user" type="text" placeholder="user"/&gt;
            &lt;button type="submit" class="btn"&gt;Ajouter un Snippet&lt;/button&gt;
            &lt;!--&lt;input type="submit" value="Ajouter un Snippet" /&gt;--&gt;
       &lt;/form&gt;
    &lt;/div&gt;

    &lt;ul id="snippet-list" style="list-style: none;"&gt;
       &lt;li data-template&gt;
        &lt;h2&gt; by &lt;/h2&gt;&lt;br&gt;
        &lt;hr&gt;
       &lt;/li&gt;
    &lt;/ul&gt;

&lt;/div&gt;

&lt;!-- js libs client --&gt;
&lt;script src="javascripts/jquery.js"&gt;&lt;/script&gt;
&lt;script src="javascripts/underscore.js"&gt;&lt;/script&gt;
&lt;script src="javascripts/backbone.js"&gt;&lt;/script&gt;
&lt;script src="javascripts/backbone.sync.js"&gt;&lt;/script&gt;
&lt;script src="javascripts/tempo.js"&gt;&lt;/script&gt;
&lt;script src="javascripts/showdown.js"&gt;&lt;/script&gt;
&lt;script src="javascripts/highlight.min.js"&gt;&lt;/script&gt;
</code></pre>

<h3>Javascript (Backbone &amp; co)</h3>

<p>Donc à la suite :</p>

<pre><code>&lt;!-- Application BackBone --&gt;

&lt;script type="text/javascript"&gt;
    $(document).ready(function() {

        window.Snippet = Backbone.Model.extend({
            url : 'snippet',
            defaults : {
                id: null,
                title : "",
                code : "",
                user : ""
            }
        });

        window.Snippets = Backbone.Collection.extend({
            model : Snippet,
            url : 'snippets'
        });

        /*=== VIEWS ===*/
        window.SnippetsView = Backbone.View.extend({

            initialize : function() {
                this.template = Tempo.prepare('snippet-list');
            },

            render : function() {
                this.template.render(this.collection.toJSON());
                return this;
            }

        });


        window.converter = new Showdown.converter();

        window.SnippetFormView = Backbone.View.extend({
            el : $('#snippet-form'),

            initialize : function() {
                this.form = arguments[0].form;
            },
            events : {
                'submit form' : 'addSnippet'
            },
            addSnippet : function(e) {
                e.preventDefault();
                var that = this;
                var tmpSnippet = new Snippet({
                    title : this.$('#title').val(),
                    code : converter.makeHtml(this.$('#code').val()),
                    user : this.$('#user').val()
                });

                tmpSnippet.save({},{
                    success : function() {
                        that.collection.fetch({
                            success: function() {
                                that.form .render();
                                $('pre code').each(function(index,e) {hljs.highlightBlock(e, '    ')});
                            }
                        })
                    }
                });
                //on vide le form
                this.$('input[type="text"]').val('');
                this.$('textarea').val('');
            },
            error : function(model, error) {
                console.log(model, error);
                return this;
            }

        });

        /*=== ROUTER ===*/

        window.SnippetsRouter = Backbone.Router.extend({

            initialize : function() {
                /* 1- Création d'une collection */
                window.snippets = new Snippets();
                this.collection = snippets;
                var that = this;
                /* 2- Chargement de la collection */
                snippets.fetch({
                    success:function() {
                        /* 3- Création des vues + affichage */
                        window.snippetsView = new SnippetsView({ collection : snippets });
                        window.snippetForm = new SnippetFormView({ collection : snippets, form : snippetsView });
                        snippetsView.render();
                        /*4- un peu de couleur */
                        $('pre code').each(function(index,e) {hljs.highlightBlock(e, '    ')});

                    },
                    error:function(){

                    }
                });

            },
            routes : {}

        });

        /*--- initialisation du router ---*/

        router = new SnippetsRouter();

    });
&lt;/script&gt;
</code></pre>

<p><strong>Remarques :</strong></p>

<ul>
<li><code>window.converter = new Showdown.converter();</code> et <code>converter.makeHtml(this.$('#code').val())</code> servent à transformer le code markdown saisi en code html</li>
<li><code>$('pre code').each(function(index,e) {hljs.highlightBlock(e, '    ')});</code> sert à "coloriser" les parties "code source"</li>
</ul>


<h3>Allez on teste :</h3>

<ul>
<li>Vérifiez que votre application est lancée</li>
<li>Ouvrez l'url <code>localhost:3000/</code> dans votre navigateur</li>
</ul>


<p><img src="https://github.com/k33g/k33g.github.com/raw/master/images/express07.png" alt="Alt &quot;express07.png&quot;" /></p>

<p>On voit que l'on a encore nos données "bootstrapées".</p>

<p>Saisissons des données au format markdown :</p>

<p><img src="https://github.com/k33g/k33g.github.com/raw/master/images/express08.png" alt="Alt &quot;express08.png&quot;" /></p>

<p>On ajoute et on obtient :</p>

<p><img src="https://github.com/k33g/k33g.github.com/raw/master/images/express09.png" alt="Alt &quot;express09.png&quot;" /></p>

<p>Vous pouvez allez vérifier dans un autre navigateur que vos données sont bien là.</p>

<h2>That's all ...</h2>

<p>Pour aujourd'hui, mais la prochaine fois, nous verrons comment "socialiser" notre application : seules les personnes authentifiées avec Twitter, pourront saisir des snippets. Nous mettrons quelques contrôles de validation. Et enfin (pas forcément dans le même article), nous verrons comment ajouter une véritable persistance avec une base NOSQL (je n'ai pas encore fait mon choix, mais j'ai un gros penchant pour CouchDB).</p>

<p>Si vous voulez voir tourner l'application "en vrai", je l'ai hébergée ici : <a href="http://stykkekode.cloudno.de/">http://stykkekode.cloudno.de/</a>.</p>

<p>@+ &amp; Bon code.</p>

        <g:plusone size="medium"></g:plusone>
        <a href="https://twitter.com/share" class="twitter-share-button" data-count="horizontal" data-via="k33g_org">Tweet</a><script type="text/javascript" src="//platform.twitter.com/widgets.js"></script>
    </div>
    <div class="whoring">
        <hr>
        <div id="disqus_thread"></div>
            <script type="text/javascript">
                /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
                var disqus_shortname = 'k33gblog'; // required: replace example with your forum shortname

                var disqus_identifier = 'Express.js comme PlayFramework';

                // The following are highly recommended additional parameters. Remove the slashes in front to use.
                // var disqus_identifier = 'unique_dynamic_id_1234';
                // var disqus_url = 'http://example.com/permalink-to-page.html';

                /* * * DON'T EDIT BELOW THIS LINE * * */
                (function() {
                    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
                    dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
                    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
                })();
            </script>
            <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
            <a href="http://disqus.com" class="dsq-brlink">blog comments powered by <span class="logo-disqus">Disqus</span></a>

    </div>


    <div id="related">
        <h2>Related Posts</h2>
            <ul class="posts">
            
              <li><span>10 May 2014</span> &raquo; <a href="/2014/05/10/ATOM-SHELL.html">Atom-shell, javascript everywhere</a></li>
            
              <li><span>09 May 2014</span> &raquo; <a href="/2014/05/09/NPM-NODE-CLI.html">Faites vos outils avec npm et node</a></li>
            
              <li><span>04 May 2014</span> &raquo; <a href="/2014/05/04/MIXIT-2014.html">MixITFR2014</a></li>
            
        </ul>
    </div>
</div>
    </div>

    <div class="row">
        <h3>A voir : Les GROS tutos Play!> 1 & 2 !, Backbone</h3>
        <ul>
            <li>
                <a href="http://3monkeys.github.com/play.rules/livre.play.deux.web/play2.rules.return.html">
                    Play!► 2 en douceur •
                </a>
                <a href="http://3monkeys.github.com/play.rules/livre.play.un.web/play.rules.one.html">
                    Apprendre Play!► 1 •
                </a>
                <a href="http://3monkeys.github.com/play.rules/">
                    Versions epub & pdf
                </a>
            </li>
            <li>
                <a href="http://k33g.github.io/backbone.en.douceur/">
                    Backbone.js "en douceur" •
                </a>
                <a href="http://k33g.github.io/backbone.en.douceur/backbone.en.douceur.20121220.pdf"><b>LE</b> pdf</a>
            </li>
            <li>
                A venir : Golo "dans tous les sens" ♥
            </li>
        </ul>
    </div>
    <hr>

</div>



<!-- Google Analytics -->
<script type="text/javascript">

  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-11383603-5']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();

</script>
<!-- Google Analytics end -->

</body>
</html>