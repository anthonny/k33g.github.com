<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us">
<head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>BB plays with Play, la suite</title>
    <meta name="author" content="k33g" />

    <!-- Homepage CSS -->
    <!--
    <link rel="stylesheet" href="http://twitter.github.io/bootstrap/assets/css/bootstrap.css">
    <link rel="stylesheet" href="/css/screen.css" type="text/css" media="screen, projection" />
	-->

    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1">
    <link href="/bootstrap3/css/bootstrap.css" rel="stylesheet" type="text/css">
    <script type="text/javascript" src="bootstrap3/js/bootstrap.min.js"></script>

    <style>
        .jumbotron {
            background-color: #b8eee9;
            border-radius: 0px;
        }
    </style>

    <!-- syntax highlighting CSS -->
    <link rel="stylesheet" href="/css/syntax.css" type="text/css" />
	<link rel="stylesheet" href="/css/default.min.css">


    <script type="text/javascript" src="https://apis.google.com/js/plusone.js"></script>

</head>

<body >

<div class="jumbotron">
    <h1>K33G_ORG's Blog</h1>
    <p></p>
    <a class="label label-info" href="/">home</a>
    <a class="label label-info" href="http://twitter.com/k33g_org/">@k33g_org</a>
    <a class="label label-warning" href="http://feeds.feedburner.com/K33g_orgsBlog">rss</a>
    <a class="label label-info" href="http://k33g.github.com/all.html">all posts</a>
</div>
<div class="container">

    <div class="row">
        <div>
    <div>
        <g:plusone size="medium"></g:plusone>
        <a href="https://twitter.com/share" class="twitter-share-button" data-count="horizontal" data-via="k33g_org">Tweet</a><script type="text/javascript" src="//platform.twitter.com/widgets.js"></script>
        <h1>BackBone Models &amp; Play!> Models jouent ensemble : La suite</h1>

<h2>Pré-requis (indispensable!)</h2>

<p>Avoir lu la 1ère partie : <a href="http://k33g.github.com/2012/02/04/BB-MODELS-AND-PLAY.html">http://k33g.github.com/2012/02/04/BB-MODELS-AND-PLAY.html</a></p>

<h2>Problématique :</h2>

<p>Je souhaite affecter une technologie à un bookmark (je classe mes bookmarks par techno).</p>

<p>C'est à dire que côté Backbone, je vais avoir ceci :</p>

<p>Dans <code>app/views/Application/index.html</code>, je vais avoir un nouveau modèle <code>Techno</code> :</p>

<pre><code>window.Techno = Backbone.Model.extend({
    url : 'bb/techno',
    defaults : {
        id: null,
        label : ""
    }
});

window.Technos = Backbone.Collection.extend({
    model : Techno,
    url : 'bb/technos'
});
</code></pre>

<p>Et je voudrais pouvoir faire des "choses" comme celles-ci :</p>

<pre><code>var jstechno = technosCollection.find(function(techno){ return techno.get("label") == "Javascript";})

var LyonJS = new Bookmark({
    label : "LyonJS",
    website : "http://lyonjs.org/",
    techno : jstechno
});

var ChezMoi = new Bookmark({
    label : "ChezWouam",
    website : "http://www.maison.fr",
    techno : new Techno({ label : "NOTECHNO" })
});
</code></pre>

<p>Mais avant d'en arriver là, il va  falloir aller coder en conséquence côté Play!>.</p>

<h2>Préparation :</h2>

<h3>Créer un modèle Play!> : Techno.java</h3>

<p>Donc dans <code>app/models</code>, créer une classe Java, <code>Techno.java</code> :</p>

<pre><code>package models;

import javax.persistence.Entity;
import play.data.validation.Required;
import play.db.jpa.Model;

@Entity
public class Techno extends Model {
    @Required public String label = "???";

    public Techno(String label) {
        this.label = label;
    }

    public Techno() {

    }

    @Override
    public String toString() {
        return label;
    }
}
</code></pre>

<h3>Créer une relation entre Bookmark.java &amp; Techno.java</h3>

<p>Donc dans <code>app/models</code>, modifier la classe Java, <code>Bookmark.java</code> en ajoutant un membre <code>techno</code> de type <code>Techno</code> et annoté avec <code>@ManyToOne</code> (pour la relation) :</p>

<pre><code>package models;

import javax.persistence.Entity;
import javax.persistence.ManyToOne;
import play.data.validation.Required;
import play.db.jpa.Model;

@Entity
public class Bookmark extends Model {
    @Required public String label;
    @Required public String website;

    //La modif c'est par là

    /* === Relations ===
        - un Bookmark est lié à une techno 
    */
    @ManyToOne
    public Techno techno;

    //Fin de la modif.

    public Bookmark(String label, String website) {
        this.label = label;
        this.website = website;
    }

    public Bookmark() {

    }   

    @Override
    public String toString() {
        return label;
    }   
}
</code></pre>

<h3>Modification conf/routes :</h3>

<p>Modifions le fichier <code>conf/routes</code> : (là même chose que pour le tuto précédent avec les bookmarks)</p>

<pre><code># Technos routes
GET     /bb/techno      Application.getTechno
POST    /bb/techno      Application.postTechno
PUT     /bb/techno      Application.putTechno
DELETE  /bb/techno      Application.deleteTechno

GET     /bb/technos     Application.allTechnos
</code></pre>

<h3>Modifions le contrôleur Application.java :</h3>

<p>Dans la classe <code>app/controllers/Application.java</code>, ajoutons les méthodes nécessaires pour gérer les opérations de CRUD des technos lorsque Backbone "envoie" des informations : (c'est exactement le même principe que pour le tuto précédent) :</p>

<pre><code>/*=== dans Application.java ===*/

/* TECHNOS */
/* GET */
public static void getTechno(String model) {
    System.out.println("getTechno : "+model);

    Gson gson = new Gson();
    Techno techno = gson.fromJson(model,Techno.class);
    Techno forFetchtechno = Techno.findById(techno.id);
    //tester if found ...
    renderJSON(forFetchtechno);
}

/* POST (CREATE) */
public static void postTechno(String model) {
    System.out.println("postTechno : "+model);

    Gson gson = new Gson();
    Techno techno = gson.fromJson(model,Techno.class);
    techno.save();

    renderJSON(techno);
}

/* PUT (UPDATE) */
public static void putTechno(String model) {
    System.out.println("putTechno : "+model);

    Gson gson = new Gson();
    Techno techno = gson.fromJson(model,Techno.class);
    Techno updatedTechno = Techno.findById(techno.id);
    updatedTechno.label = techno.label;
    updatedTechno.save();

    renderJSON(updatedTechno);
}
/* DELETE */
public static void deleteTechno(String model) {
    System.out.println("deleteTechno : "+model);

    Gson gson = new Gson();
    Techno techno = gson.fromJson(model,Techno.class);
    Techno technoToBeDeleted = Techno.findById(techno.id);
    //tester if found ...
    technoToBeDeleted.delete();

    renderJSON(technoToBeDeleted);
}
/* GET */
public static void allTechnos() {
    System.out.println("allTechnos");

    List&lt;Techno&gt; technos = Techno.findAll();
    renderJSON(new Gson().toJson(technos)); 
}
</code></pre>

<p>Maintenant, passons aux choses sérieuses :</p>

<h2>Gestion de la relation côté Play!></h2>

<p>Nous allons modifier les méthodes relatives aux bookmarks dans <code>Application.java</code>.</p>

<p>Les méthodes suivantes ne changent pas (pour ce qui concerne ce tuto, car je ne traîte pas tous les cas de figure) :</p>

<ul>
<li><code>public static void getBookmark(String model) // GET-read</code></li>
<li><code>public static void deleteBookmark(String model) // DELETE-delete</code></li>
<li><code>public static void allBookmarks() // GET</code></li>
</ul>


<p>Seules changent : <code>postBookmark</code> et <code>putBookmark</code></p>

<p>Que fait on ?</p>

<p>Lorsque Play!> (en fait le contrôleur) reçoit un bookmark "JSONisé" de Backbone, on vérifie :</p>

<ul>
<li>si il a une techno (si il est lié à une techno),</li>
<li>et si cette techno a un <code>id</code> renseigné</li>
<li>si cet <code>id</code> n'est pas renseigné, on crée/persiste la techno en base : <code>bookmark.techno.save();</code></li>
<li><p>dans le cas d'un <code>update</code>, avant de faire un <code>save</code>, on associe l'instance techno à l'instance bookmark (sinon Hibernate va g.....r au moment du <code>save()</code>) : <code>updatedBookmark.techno = techno;</code></p>

<pre><code>  /*=== dans Application.java ===*/

  /* BOOKMARKS */

  /* POST (CREATE) */
  public static void postBookmark(String model) {
      System.out.println("postBookmark : "+model);

      Gson gson = new Gson();
      Bookmark bookmark = gson.fromJson(model,Bookmark.class);

      if(bookmark.techno!=null){
          Techno techno = bookmark.techno;
          //si la techno n'existe pas on la crée
          if(bookmark.techno.id == null) {
              bookmark.techno.save();
          }
      }

      bookmark.save();

      renderJSON(bookmark);
  }

  /* PUT (UPDATE) */
  public static void putBookmark(String model) {
      System.out.println("putBookmark : "+model);

      Gson gson = new Gson();
      Bookmark bookmark = gson.fromJson(model,Bookmark.class);

      Bookmark updatedBookmark = Bookmark.findById(bookmark.id);

      updatedBookmark.label   = bookmark.label;

      if(bookmark.techno!=null){
          Techno techno = bookmark.techno;
          //si la techno n'existe pas on la crée
          if(bookmark.techno.id == null) {
              bookmark.techno.save();
          }
          updatedBookmark.techno = techno;
      }

      updatedBookmark.save();

      renderJSON(updatedBookmark);
  }
</code></pre></li>
</ul>


<h2>Allons faire un tour chez Backbone</h2>

<p>Maintenant que tout est prêt côté serveur, on peut aller s'amuser côté client.</p>

<h3>Ajoutons quelques technos :</h3>

<p>Dans la console de votre navigateur préféré :</p>

<pre><code>t1 = new Techno({label:"Javascript"}).save();
t2 = new Techno({label:"Coffeescript"}).save();
t3 = new Techno({label:"Java"}).save();
t4 = new Techno({label:".Net"}).save();
t5 = new Techno({label:"Scala"}).save();
t6 = new Techno({label:"HTML5"}).save();
t7 = new Techno({label:"CSS3"}).save();
t8 = new Techno({label:"Kotlin"}).save();
t9 = new Techno({label:"Ceylon"}).save();
//Oui je sais, normalement il faut que j'utilise des callbacks, mais on s'en fout, c'est une démo
</code></pre>

<p>Puis on vérifie que "tout s'est bien passé" :</p>

<pre><code>technosCollection = new Technos();
technosCollection.fetch({success: function() {
        technosCollection.each(function(techno){ console.log(techno.get("id"),techno.get("label")); });
}});
</code></pre>

<p><img src="https://github.com/k33g/k33g.github.com/raw/master/images/bbplay_2_001.png" alt="Alt &quot;bbplay_2_001.png&quot;" /></p>

<h3>Création d'un nouveau bookmark avec une techno existante</h3>

<p>Toujours dans la console :</p>

<pre><code>var jstechno = technosCollection.find(function(techno){ return techno.get("label") == "Javascript";})

var LyonJS = new Bookmark({
    label : "LyonJS",
    website : "http://lyonjs.org/",
    techno : jstechno
});

LyonJS.save();
</code></pre>

<h3>Création d'un nouveau bookmark avec une nouvelle techno</h3>

<p>Toujours dans la console :</p>

<pre><code>var ChezMoi = new Bookmark({
    label : "ChezWouam",
    website : "http://www.maison.fr",
    techno : new Techno({ label : "NOTECHNO" })
});

ChezMoi.save();
</code></pre>

<h3>Vérifications :</h3>

<p>Encore dans la console :</p>

<pre><code>bookmarks = new Bookmarks();
bookmarks.fetch({
    success: function() {
        bookmarks.each(function(bookmark) { console.log(bookmark.get("id"), bookmark.get("label")); });
    }
});
</code></pre>

<p>On voit que nos bookmarks ont bien été ajoutés :</p>

<p><img src="https://github.com/k33g/k33g.github.com/raw/master/images/bbplay_2_002.png" alt="Alt &quot;bbplay_2_002.png&quot;" /></p>

<p>Vérifions aussi les technos :</p>

<pre><code>technosCollection = new Technos();
technosCollection.fetch({
    success: function() {
        technosCollection.each(function(techno){ console.log(techno.get("id"),techno.get("label")); });
    }
});
</code></pre>

<p><img src="https://github.com/k33g/k33g.github.com/raw/master/images/bbplay_2_003.png" alt="Alt &quot;bbplay_2_003.png&quot;" /></p>

<h3>Vérification ultime :</h3>

<p>On reste dans la console :</p>

<pre><code>var LyonJS = bookmarks.find(function(bookmark){ return bookmark.get("label") == "LyonJS";});
</code></pre>

<p>Puis faites :</p>

<pre><code>LyonJS.get("techno");
</code></pre>

<p>ça c'est bon, donc on continue :</p>

<pre><code>LyonJS.get("techno").get("label");
</code></pre>

<p>Arghhhh ! Et là, c'est le drame (encore) :</p>

<p>Vous obtenez un <strong>"horrible"</strong> <code>TypeError: Object #&lt;Object&gt; has no method 'get'</code></p>

<p><img src="https://github.com/k33g/k33g.github.com/raw/master/images/bbplay_2_004.png" alt="Alt &quot;bbplay_2_004.png&quot;" /></p>

<h3>Mais que s'est-il donc passé ?</h3>

<p>En fait, lorsque que vous avez fait un <code>fetch()</code> du bookmark, il a bien "récupéré" les infos du serveur, mais n'a pas "casté" la techno du bookmark en <code>Backbone.Model</code>, donc votre techno (du bookmark) existe bien, mais est un simple <code>Object</code>. Les données sont bien là, vous pouvez vérifier en faisant ceci : <code>LyonJS.get("techno").label;</code></p>

<h3>Mais ça m'arrange pas ! Comment fait-on ?</h3>

<p>Je vais vous présenter une méthode "à l'arrache", pas forcément la plus éléguante, mais qui a le mérite d'être simple et donc de vous éviter beaucoup de soucis (d'effets de bord) pour finalement pas beaucoup d'effort.
Nous allons ajouter une méthode <code>fetchWithTechno</code> à notre modèle <code>Bookmark</code> (nous sommes toujours côté Backbone pour mémoire) :</p>

<pre><code>window.Bookmark = Backbone.Model.extend({
    url : 'bb/bookmark',
    defaults : {
        id: null,
        label : "",
        website : ""
    },
    initialize : function Bookmark(){
        console.log("Hello i'am a bookmark ...");
        return this;
    },

    fetchWithTechno : function (callbck) {
        this.fetch({success:function(model){
                if(model.get("techno")){
                    var techno = new Techno({id:model.get("techno").id});
                    techno.fetch({
                        success:function(technoModel){
                            delete model.techno;
                            model.set({techno : technoModel});
                            if(callbck) callbck(model);
                        }
                    })
                } else {
                    if(callbck) callbck(model);
                }
        }});
    }
});
</code></pre>

<h4>Que fait donc <code>fetchWithTechno()</code> ?</h4>

<p>Cette méthode, fait un fetch du bookmark, vérifie s'il a une techno, et si c'est la cas, fait un fetch de cette techno afin de la "caster" en <code>Backbone.Model</code>.</p>

<h4>On vérifie ? (penser à raffraîchir la page de votre navigateur)</h4>

<pre><code>//on récupère la liste des bookmarks

var bookmarks = new Bookmarks();
bookmarks.fetch({
    success: function() {
        bookmarks.each(function(bookmark) { 
            console.log(bookmark.get("id"), bookmark.get("label")); 
        });
    }
});

//on récupère notre bookmark :

var LyonJS = bookmarks.find(function(bookmark){ return bookmark.get("label") == "LyonJS";});

//on le "fetch" mais avec la nouvelle méthode

LyonJS.fetchWithTechno(function(model){ console.log(model.get("techno").get("label"));})
//ou
LyonJS.fetchWithTechno(function(){ console.log(LyonJS.get("techno").get("label"));})
</code></pre>

<p>Et là la techno de notre bookmark est bien un <code>Backbone.Model</code>. :)</p>

<h3>Allez, un dernier pour la route, on fait la même chose pour la collection :</h3>

<pre><code>window.Bookmarks = Backbone.Collection.extend({
    model : Bookmark,
    url : 'bb/bookmarks',
    fetchWithTechnos : function(callbck) {
        var that = this; // c'est important (on conserve le contexte)
        this.fetch({
            success : function() {
                that.each(function(bookmark){
                    if(bookmark.get("techno")) {
                        var techno = new Techno({id : bookmark.get("techno").id}); 
                        techno.fetch({
                            success:function(technoModel){
                                delete bookmark.techno;
                                bookmark.set({techno : technoModel});
                                console.log("model with techno : ", bookmark, bookmark.get("techno").get("label"));
                            } // end success
                        }); // end fetch techno
                    } // end if
                }); // end each
                if(callbck) callbck(that);
            } // end success
        }); //end fetch collection

    }
});
</code></pre>

<h4>Et on se fait une dernière vérification :</h4>

<pre><code>var bookmarks = new Bookmarks();
bookmarks.fetchWithTechnos(function(){ console.log("Rahhhh ! Lovely ! ça fonctionne ...");})
</code></pre>

<p>Et ça marche !</p>

<p><img src="https://github.com/k33g/k33g.github.com/raw/master/images/bbplay_2_005.png" alt="Alt &quot;bbplay_2_005.png&quot;" /></p>

<p>Bon, c'est terminé. Maintenant à vous de bosser ! Il reste plein de choses à faire : par exemple si vous tentez de supprimer une techno qui est attachée à un ou des bookmarks, ça va p***r côté serveur.</p>

<p><strong>PS:</strong> : Si vous relevez des erreurs, si vous avez quelque chose de plus "élégant" pour le faire, etc. ... Allez-y, je ne me vexerais pas, bien au contraire.</p>

<h2>@+</h2>

<p><em>... tiens avec Play!> v°2, ça donnerait quoi ? ... ;)</em></p>

        <g:plusone size="medium"></g:plusone>
        <a href="https://twitter.com/share" class="twitter-share-button" data-count="horizontal" data-via="k33g_org">Tweet</a><script type="text/javascript" src="//platform.twitter.com/widgets.js"></script>
    </div>
    <div class="whoring">
        <hr>
        <div id="disqus_thread"></div>
            <script type="text/javascript">
                /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
                var disqus_shortname = 'k33gblog'; // required: replace example with your forum shortname

                var disqus_identifier = 'BB plays with Play, la suite';

                // The following are highly recommended additional parameters. Remove the slashes in front to use.
                // var disqus_identifier = 'unique_dynamic_id_1234';
                // var disqus_url = 'http://example.com/permalink-to-page.html';

                /* * * DON'T EDIT BELOW THIS LINE * * */
                (function() {
                    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
                    dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
                    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
                })();
            </script>
            <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
            <a href="http://disqus.com" class="dsq-brlink">blog comments powered by <span class="logo-disqus">Disqus</span></a>

    </div>


    <div id="related">
        <h2>Related Posts</h2>
            <ul class="posts">
            
              <li><span>10 Dec 2013</span> &raquo; <a href="/2013/12/10/POLYMER-2.html">Polymer 1er contact le retour</a></li>
            
              <li><span>07 Dec 2013</span> &raquo; <a href="/2013/12/07/POLYMER-1.html">Polymer 1er contact</a></li>
            
              <li><span>29 Nov 2013</span> &raquo; <a href="/2013/11/29/BBOM.html">Le modèle objet de Backbone</a></li>
            
        </ul>
    </div>
</div>
    </div>

    <div class="row">
        <h3>A voir : Les GROS tutos Play!> 1 & 2 !, Backbone</h3>
        <ul>
            <li>
                <a href="http://3monkeys.github.com/play.rules/livre.play.deux.web/play2.rules.return.html">
                    Play!► 2 en douceur •
                </a>
                <a href="http://3monkeys.github.com/play.rules/livre.play.un.web/play.rules.one.html">
                    Apprendre Play!► 1 •
                </a>
                <a href="http://3monkeys.github.com/play.rules/">
                    Versions epub & pdf
                </a>
            </li>
            <li>
                <a href="http://k33g.github.io/backbone.en.douceur/">
                    Backbone.js "en douceur" •
                </a>
                <a href="http://k33g.github.io/backbone.en.douceur/backbone.en.douceur.20121220.pdf"><b>LE</b> pdf</a>
            </li>
            <li>
                A venir : Golo "dans tous les sens" ♥
            </li>
        </ul>
    </div>
    <hr>

</div>



<!-- Google Analytics -->
<script type="text/javascript">

  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-11383603-5']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();

</script>
<!-- Google Analytics end -->

</body>
</html>