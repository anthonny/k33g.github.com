<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us">
<head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>stykkekode la suite</title>
    <meta name="author" content="k33g" />

    <!-- Homepage CSS -->
    <!--
    <link rel="stylesheet" href="http://twitter.github.io/bootstrap/assets/css/bootstrap.css">
    <link rel="stylesheet" href="/css/screen.css" type="text/css" media="screen, projection" />
	-->

    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1">
    <link href="/bootstrap3/css/bootstrap.css" rel="stylesheet" type="text/css">
    <script type="text/javascript" src="bootstrap3/js/bootstrap.min.js"></script>

    <style>
        .jumbotron {
            background-color: #444444;
            border-radius: 0px;
            padding: 10px 30px;
        }
    </style>

    <!-- syntax highlighting CSS -->
    <link rel="stylesheet" href="/css/syntax.css" type="text/css" />
		<link rel="stylesheet" href="/css/default.min.css">


    <script type="text/javascript" src="https://apis.google.com/js/plusone.js"></script>

</head>

<body >

<div class="jumbotron">
    <a class="label label-warning" href="/">K33G_ORG's Blog</a>
    <a class="label label-info" href="http://twitter.com/k33g_org/">@k33g_org</a>
    <a class="label label-warning" href="http://feeds.feedburner.com/K33g_orgsBlog">rss</a>
    <a class="label label-info" href="http://k33g.github.com/all.html">all posts</a>
    <a class="label label-warning" href="http://www.k33g.org/">me</a>
</div>
<div class="container">

    <div class="row">
        <div>
    <div>
        <g:plusone size="medium"></g:plusone>
        <a href="https://twitter.com/share" class="twitter-share-button" data-count="horizontal" data-via="k33g_org">Tweet</a><script type="text/javascript" src="//platform.twitter.com/widgets.js"></script>
        <h1>Express.js, le Play!>Framework du Javascript ? presque la Fin ...</h1>

<h2>Il vous faut :</h2>

<ul>
<li>avoir suivi les épisodes précédents : <a href="http://k33g.github.com/2012/02/19/EXPRESSJS_IS_PLAY.html">Partie 1</a> et <a href="http://k33g.github.com/2012/02/26/EXPRESSJS-RETURN.html">Partie 2</a></li>
<li>installer CouchDB : <a href="http://couchdb.apache.org/index.html">http://couchdb.apache.org/index.html</a> vous pouvez trouver les binaires ici : <a href="http://www.couchbase.com/download">http://www.couchbase.com/download</a></li>
<li>installer cradle dans votre répertoire applicatif <a href="https://github.com/cloudhead/cradle">https://github.com/cloudhead/cradle</a></li>
</ul>


<p><strong>Cradle</strong> est le client CouchDB pour node.js.</p>

<h3>Installer cradle :</h3>

<pre><code>cd stykkekode
npm install cradle
</code></pre>

<h2>Créer une base "snippets" dans couchdb</h2>

<p><img src="https://github.com/k33g/k33g.github.com/raw/master/images/express15.png" alt="Alt &quot;express15.png&quot;" /></p>

<p><img src="https://github.com/k33g/k33g.github.com/raw/master/images/express16.png" alt="Alt &quot;express16.png&quot;" /></p>

<h2>Créer une vue dans couchdb :</h2>

<p>Il suffit de créer un nouveau document dans la base "snippets" avec l'interface d'administration de CouchDB, avec le code suivant :</p>

<pre><code>{
   "_id": "_design/snippets",
   "language": "javascript",
   "views": {
       "all": {
           "map": "function(doc) { if (doc.user)  emit(doc) }"
       }
   }
}
</code></pre>

<p><img src="https://github.com/k33g/k33g.github.com/raw/master/images/express17.png" alt="Alt &quot;express17.png&quot;" /></p>

<h2>Modifions notre modèle "snippet.js" :</h2>

<p>Remplacez le code existant par celui ci :</p>

<pre><code>/* SNIPPET MODEL */

//utilisation de cradle
var cradle = require('cradle');

var snippet = function(title, code, user) {
    this.id = null;
    this.title = title ? title : "";
    this.code = code ? code : "";
    this.user = user ? user : "";
}

//déclaration de la connexion
snippet.connection = new cradle.Connection ('localhost', 5984, { cache : true, raw : false });
snippet.db = snippet.connection.database('snippets');


//static
snippet.list = [];

snippet.prototype.save = function(callBack) {
    if(this.id === undefined || this.id === null || this.id === "") {
        var that = this;

            snippet.db.save(this, function(error, result) {
                if( error ) { callBack(error) }
                else {
                    console.log("Result : ", result);
                    that.id = result.id;
                    callBack(that);
                }
            });

    } else {
        //snippet exists
    }
};


snippet.findAll = function(callback) {
    snippet.db.view('snippets/all',function(error, result) {
      if( error ){
        callback(error)
      }else{
        var docs = [];
        result.forEach(function (row){
          docs.push(row.key);
        });
        callback(docs);
      }
    });
};


exports.snippet = snippet;
</code></pre>

<h2>Modifions notre modèle "user.js"</h2>

<p>On ajoute cette ligne <code>user.twitterListById[authenticatedUser.sourceUser.screen_name] = authenticatedUser;</code> dans la méthode <code>add</code></p>

<pre><code>user.add = function(source, sourceUser) {
    user.nextUserId+=1;
    var authenticatedUser = new user(user.nextUserId, source, sourceUser);
    console.log("#################################");
    console.log(authenticatedUser.sourceUser.name);
    console.log(authenticatedUser.sourceUser.profile_image_url);
    console.log("#################################");
    user.listById[authenticatedUser.id] = authenticatedUser;

    user.twitterListById[authenticatedUser.sourceUser.screen_name] = authenticatedUser;

    return authenticatedUser;
};
</code></pre>

<h2>Modifions routes/index.js</h2>

<p>En début de fichier, ajouter la référence à <code>user</code> :</p>

<pre><code>var user = require('../models/user').user;
</code></pre>

<p>puis modifions <code>createSnippet</code> :</p>

<pre><code>exports.createSnippet = function(req, res) {
    console.log("CREATE SNIPPET");

    var model_from_client = JSON.parse(req.param("model", null));
    console.log(model_from_client);

    /*tronquer le code*/
    model_from_client.code = model_from_client.code.substring(0,1455);

    var server_model = new snippet(model_from_client.title, model_from_client.code, model_from_client.user);

    //On ne sauvegarde uniquement si l'utilisateur est authentifié
    if(user.findByTwitterId(model_from_client.user)) {
        console.log("model_from_client.user",model_from_client.user);
        server_model.save(function(m){
            console.log(m);
            res.json(m);
        });
    }
</code></pre>

<h2>Vous pouvez tester !</h2>

<ul>
<li>saisissez quelques données dans votre application</li>
<li>puis allez voir dans la console d'administration de CouchDB</li>
</ul>


<p><img src="https://github.com/k33g/k33g.github.com/raw/master/images/express18.png" alt="Alt &quot;express18.png&quot;" /></p>

<ul>
<li>Vos données sont bien persistées</li>
<li>Vous remarquerez que nous n'avons rien eu pour le moment à changer dans le code concernant Backbone.</li>
</ul>


<h2>La prochaine fois ...</h2>

<p>Nous allons paginer, donc écrire de nouvelles vues pour CouchDB, et jouer un peu avec Backbone.</p>

<p>@+.</p>

        <g:plusone size="medium"></g:plusone>
        <a href="https://twitter.com/share" class="twitter-share-button" data-count="horizontal" data-via="k33g_org">Tweet</a><script type="text/javascript" src="//platform.twitter.com/widgets.js"></script>
    </div>
    <div class="whoring">
        <hr>
        <div id="disqus_thread"></div>
            <script type="text/javascript">
                /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
                var disqus_shortname = 'k33gblog'; // required: replace example with your forum shortname

                var disqus_identifier = 'stykkekode la suite';

                // The following are highly recommended additional parameters. Remove the slashes in front to use.
                // var disqus_identifier = 'unique_dynamic_id_1234';
                // var disqus_url = 'http://example.com/permalink-to-page.html';

                /* * * DON'T EDIT BELOW THIS LINE * * */
                (function() {
                    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
                    dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
                    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
                })();
            </script>
            <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
            <a href="http://disqus.com" class="dsq-brlink">blog comments powered by <span class="logo-disqus">Disqus</span></a>

    </div>


    <div id="related">
        <h2>Related Posts</h2>
            <ul class="posts">
            
              <li><span>10 May 2014</span> &raquo; <a href="/2014/05/10/ATOM-SHELL.html">Atom-shell, javascript everywhere</a></li>
            
              <li><span>09 May 2014</span> &raquo; <a href="/2014/05/09/NPM-NODE-CLI.html">Faites vos outils avec npm et node</a></li>
            
              <li><span>04 May 2014</span> &raquo; <a href="/2014/05/04/MIXIT-2014.html">MixITFR2014</a></li>
            
        </ul>
    </div>
</div>
    </div>

    <div class="row">
        <h3>A voir : Les GROS tutos Play!> 1 & 2 !, Backbone</h3>
        <ul>
            <li>
                <a href="http://3monkeys.github.com/play.rules/livre.play.deux.web/play2.rules.return.html">
                    Play!► 2 en douceur •
                </a>
                <a href="http://3monkeys.github.com/play.rules/livre.play.un.web/play.rules.one.html">
                    Apprendre Play!► 1 •
                </a>
                <a href="http://3monkeys.github.com/play.rules/">
                    Versions epub & pdf
                </a>
            </li>
            <li>
                <a href="http://k33g.github.io/backbone.en.douceur/">
                    Backbone.js "en douceur" •
                </a>
                <a href="http://k33g.github.io/backbone.en.douceur/backbone.en.douceur.20121220.pdf"><b>LE</b> pdf</a>
            </li>
            <li>
                A venir : Golo "dans tous les sens" ♥
            </li>
        </ul>
    </div>
    <hr>

</div>



<!-- Google Analytics -->
<script type="text/javascript">

  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-11383603-5']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();

</script>
<!-- Google Analytics end -->

</body>
</html>